<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MB Gardiennage ‚Äî Planning</title>
<style>
  :root{
    --bg:#0b1220; --text:#e5e7eb; --muted:#9aa3b2;
    --card:#0f172a; --border:#1f2a44; --shadow:0 10px 30px rgba(0,0,0,.35);
    --c:#1e88ff; --p:#08a86b; --g:#ff8a2a; --r:#8b5cf6; --accent:#2b5cff;
    --sidebar:#0f172a; --sidebar-border:#1f2a44; --sidebar-hover:#162746;
    --chip:#101b33; --chip-bd:#2c3b63;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

  .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
  .side{background:var(--sidebar);border-right:1px solid var(--sidebar-border);padding:16px 12px}
  .logo{font-weight:900;font-size:18px;color:#cfe0ff;margin-bottom:12px}
  .people{display:flex;flex-direction:column;gap:6px}
  .person{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .person:hover{background:var(--sidebar-hover)}
  .person.active{outline:2px solid #2b5cff66}
  .badge{width:10px;height:10px;border-radius:50%}
  .sep{height:1px;background:var(--sidebar-border);margin:8px 0}
  .general-label{font-size:12px;color:#9aa3b2;margin:6px 12px 0}

  header{position:sticky;top:0;background:var(--bg);z-index:15;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 12px 10px;border-bottom:1px solid #1b2340}
  h1{margin:0;font-size:20px}
  #monthLabel{cursor:pointer;border-bottom:2px dashed transparent}
  #monthLabel:hover{border-color:#2b5cff}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  button{background:#13213d;border:1px solid #2a3d6d;color:#e5e7eb;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
  button:hover{background:#142a57}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.danger{border-color:#7f1d1d;background:#3f1d1d;color:#fecaca}
  #menuBtn{display:none;border-radius:10px;padding:8px 10px}

  .wrap{max-width:1140px;margin:0 auto 40px;padding:0 12px}
  .legend{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 12px}
  .tag{display:inline-flex;gap:8px;align-items:center;font-size:13px;color:#94a3b8}
  .sw{width:14px;height:14px;border-radius:4px;display:inline-block}
  .totals{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .box{background:#0f172a;border:1px solid #1f2a44;border-radius:12px;padding:10px 14px;box-shadow:var(--shadow)}
  .box h3{margin:0 0 4px;font-size:11px;color:#9aa3b2;letter-spacing:.08em}
  .box div{font-size:18px;font-weight:900}

  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .dow{font-size:12px;color:#9aa3b2;text-transform:uppercase;letter-spacing:.06em;text-align:center}
  .card{background:linear-gradient(180deg,#0f172a,#0c1426);border:1px solid #202b48;border-radius:16px;padding:10px;min-height:112px;position:relative;box-shadow:var(--shadow);transition:transform .08s ease}
  .card:hover{transform:translateY(-1px)}
  .date{position:absolute;top:8px;left:10px;font-weight:900;font-size:13px;color:#94a3b8}
  .pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;padding:7px 11px;border-radius:999px;font-weight:900;margin-top:8px;width:max-content;color:#fff;border:none}
  .pill[data-type="C"]{background:var(--c)} .pill[data-type="P"]{background:var(--p)}
  .pill[data-type="G"]{background:var(--g)} .pill[data-type="R"]{background:var(--r)}
  .pill.place{background:#27406f}
  .note{font-size:12px;color:#a78bfa;margin-top:6px}
  .mates{font-size:12px;color:#94a3b8;margin-top:6px}
  .empty{opacity:.25}

  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{background:var(--chip);border:1px solid var(--chip-bd);border-radius:999px;padding:7px 10px;font-weight:800;cursor:pointer}
  .chip:hover{background:#182a55}
  .modal-back{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:30}
  .modal{background:#0f172a;max-width:620px;width:100%;border-radius:16px;padding:14px;border:1px solid #1f2a44;box-shadow:0 22px 48px rgba(0,0,0,.5)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:#cbd5e1;font-weight:700}
  input,select{width:100%;padding:10px;border:1px solid #2a3d6d;border-radius:10px;font-size:14px;background:#091124;color:#e5e7eb}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}

  /* Badge f√©ri√© */
  .holiday{position:absolute;top:8px;right:10px;font-size:11px;font-weight:900;color:#fecaca;background:#3f1d1d;border:1px solid #7f1d1d;padding:3px 6px;border-radius:999px}

  @media (max-width:880px){
    .app{grid-template-columns:1fr}
    .side{position:static}
    #menuBtn{display:inline-block}
    .wrap{padding:0 10px}
    .calendar{grid-template-columns:repeat(2,1fr);gap:8px}
    .card{min-height:108px;padding:10px}
    .pill{padding:8px 12px;font-size:14px}
    h1{font-size:18px}
  }

  .toast{position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none;z-index:50}

  /* Edit mode badge */
  .edit-badge{position:fixed;right:18px;top:12px;background:#111827;color:#fff;border:1px solid #2a3d6d;border-radius:999px;padding:8px 12px;font-weight:900;box-shadow:var(--shadow);display:none;z-index:60}
  .edit-badge .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#10b981;margin-right:8px;box-shadow:0 0 0 3px rgba(16,185,129,.25)}

  /* Print */
  @page { size: A4 landscape; margin: 10mm; }
  * { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
  #printHeader { display:none; }
  #printHeader .ph-top{display:flex;justify-content:space-between;align-items:flex-end}
  #printHeader .ph-brand{font-weight:900;font-size:18px}
  #printHeader .ph-meta{display:flex;gap:12px;color:#333}
  #printHeader .ph-legend{display:flex;gap:12px;margin:6px 0 2px}
  #printHeader .ph-sep{border:0;border-top:2px solid #ddd;margin:6px 0 10px}
  #printHeader .sw{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:6px;vertical-align:-2px;border:1px solid #999}
  #printHeader .ph-c{background:#1e88ff}
  #printHeader .ph-p{background:#08a86b}
  #printHeader .ph-g{background:#ff8a2a}
  #printHeader .ph-r{background:#8b5cf6}
  @media print {
    html,body { background:#fff; color:#111; }
    .side, header .toolbar, #menuBtn, .modal-back, .toast, .edit-badge { display:none !important; }
    #printHeader { display:block !important; }
    .wrap { max-width: none; padding:0; margin:0; }
    .calendar { grid-template-columns: repeat(7, 1fr) !important; gap: 6px !important; }
    .card { background:#fff !important; border:1px solid #d9dee8 !important; box-shadow:none !important; min-height:92px !important; padding:8px 8px 6px 8px !important; }
    .card.work { border-color:#9db6ff !important; }
    .date { color:#374151 !important; font-weight:700 !important; font-size:12px !important; }
    .pill { margin-top:8px !important; padding:6px 9px !important; font-size:12px !important; border:1px solid rgba(0,0,0,.08) !important; color:#000 !important; }
    .pill[data-type="C"]{ background:#d9e8ff !important; }
    .pill[data-type="P"]{ background:#d6f4e4 !important; }
    .pill[data-type="G"]{ background:#ffe4cc !important; }
    .pill[data-type="R"]{ background:#eadcff !important; }
    .pill.place{ background:#eef2ff !important; }
    .note  { color:#444 !important; font-size:11px !important; margin-top:4px !important; }
    .mates { color:#333 !important; font-size:11px !important; margin-top:4px !important; }
    .totals { display:flex; justify-content:flex-end; gap:6px; margin:4px 0 8px 0 !important; }
    .box { background:#fff !important; border:1px solid #d9dee8 !important; box-shadow:none !important; padding:6px 8px !important; border-radius:8px !important; }
    .box h3 { font-size:10px !important; color:#555 !important; margin:0 0 2px !important; }
    .box div { font-size:13px !important; color:#111 !important; }
  }
</style>
</head>
<body>
<div id="app" class="app">
  <aside class="side">
    <div class="logo">üóìÔ∏è MB Gardiennage</div>
    <div class="people" id="people"></div>
    <div class="sep"></div>
    <div class="general-label">Vue globale</div>
    <div class="person" id="btnGeneral"><span class="badge" style="background:#7dd3fc"></span>Planning g√©n√©rale</div>
    <div style="margin-top:14px;color:#9aa3b2;font-size:12px">Astuce : clique le <b>mois</b> pour changer.</div>
  </aside>
  <main>
    <header>
      <button id="menuBtn" aria-label="Ouvrir le menu">‚ò∞</button>
      <h1><span id="monthLabel">‚Äî</span> ‚Äî <span id="who" style="color:#9aa3b2">‚Äî</span></h1>
      <div class="toolbar">
        <button id="btnEdit">Activer l‚Äô√©dition</button>
        <button id="btnPeople">Noms</button>
        <button id="btnPdf">PDF</button>
        <button id="btnSaveAll">Enregistrer</button>
        <button id="btnBackup">Export JSON</button>
        <button id="btnImport">Import JSON</button>
        <input type="file" id="fileImport" accept="application/json" hidden>
        <button id="btnReset" class="danger">Tout effacer</button>
      </div>
    </header>

    <div id="editBadge" class="edit-badge" aria-live="polite"><span class="dot"></span>√âdition activ√©e</div>

    <div class="wrap">
      <div id="printHeader" style="display:none">
        <div class="ph-top">
          <div class="ph-brand">MB Gardiennage ‚Äî Planning</div>
          <div class="ph-meta">
            <div><b id="phPerson">‚Äî</b></div>
            <div id="phMonth">‚Äî</div>
            <div>G√©n√©r√© le <span id="phDate">‚Äî</span></div>
          </div>
        </div>
        <div class="ph-legend">
          <span><span class="sw ph-c"></span> C</span>
          <span><span class="sw ph-p"></span> P</span>
          <span><span class="sw ph-g"></span> G</span>
          <span><span class="sw ph-r"></span> Cong√©</span>
        </div>
        <hr class="ph-sep" />
      </div>

      <div class="legend">
        <span class="tag"><span class="sw" style="background:var(--c)"></span> C</span>
        <span class="tag"><span class="sw" style="background:var(--p)"></span> P</span>
        <span class="tag"><span class="sw" style="background:var(--g)"></span> G</span>
        <span class="tag"><span class="sw" style="background:var(--r)"></span> Cong√©</span>
      </div>
      <div id="totals" class="totals"></div>
      <div id="cal" class="calendar" aria-live="polite"></div>
    </div>
  </main>
</div>

<!-- Modale √©dition -->
<div class="modal-back" id="mb">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <h2 id="mTitle">Modifier</h2>
    <div class="chips">
      <span class="chip" data-preset='{"type":"P","detail":"Promenade 7h/13h30 - 15h/21h30","autoHours":true}'>Promenade 7h/13h30 - 15h/21h30</span>
      <span class="chip" data-preset='{"type":"P","detail":"Promenade 9h/15h - 16h30/21h30","autoHours":true}'>Promenade 9h/15h - 16h30/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h/12h - 13h30/21h30","autoHours":true}'>Colline 7h/12h - 13h30/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 9h/13h30 - 15h/21h30","autoHours":true}'>Colline 9h/13h30 - 15h/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h30/12h - 13h/19h30","autoHours":true}'>Colline 7h30/12h - 13h/19h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h30/13h - 14h/21h30","autoHours":true}'>Colline 7h30/13h - 14h/21h30</span>
      <span class="chip" data-preset='{"type":"G","detail":"Grande Arche 7h30/12h - 13h30/21h","autoHours":true}'>Grande Arche 7h30/12h - 13h30/21h</span>
      <span class="chip" id="copyPrev">Copier la veille</span>
    </div>
    <div class="row">
      <div>
        <label>Type</label>
        <select id="fType">
          <option value="C">C</option>
          <option value="P">P</option>
          <option value="G">G</option>
          <option value="R">Cong√©</option>
        </select>
      </div>
      <div>
        <label>Heures</label>
        <input id="fHours" type="number" step="0.5" min="0" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>D√©tail</label>
        <input id="fDetail" placeholder="Ex: Promenade 7h‚Äì12 / 13h30‚Äì21h30" />
      </div>
      <div>
        <label>Note</label>
        <input id="fNote" placeholder="Fin 19h" />
      </div>
    </div>
    <div class="actions">
      <button id="btnWeek">Remplir la semaine</button>
      <button id="btnRange">Appliquer sur une plage</button>
      <button id="btnDel" class="danger">Supprimer</button>
      <button id="btnClose">Fermer</button>
      <button id="btnSave" class="primary">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Modale info -->
<div class="modal-back" id="infoBack">
  <div class="modal" role="dialog" aria-modal="true">
    <h3 id="infoTitle" style="margin-top:0">D√©tails du jour</h3>
    <div id="infoBody" style="display:grid;grid-template-columns:1fr;gap:8px"></div>
    <div class="actions">
      <button id="infoEdit" class="primary" style="display:none">Modifier</button>
      <button id="infoClose">Fermer</button>
    </div>
  </div>
</div>

<!-- Choix du mois -->
<div class="modal-back" id="mpb">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Choisir un mois ‚Äî <span id="curYear"></span></h3>
    <div id="monthGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px"></div>
    <div class="actions"><button id="mpClose">Fermer</button></div>
  </div>
</div>

<!-- Gestion des personnes -->
<div class="modal-back" id="peopleModal">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Ajout & modification des noms</h3>
    <div id="pmList" class="pm-list"></div>
    <div class="actions">
      <button id="pmAdd">Ajouter un nom</button>
      <button id="pmCancel">Annuler</button>
      <button id="pmSave" class="primary">Enregistrer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Enregistr√© ‚úÖ</div>

<script>
// ====== S√©curit√© syntaxique minimale ======
window.addEventListener('error', function(e){
  try{ console.error('JS error:', e.error || e.message || e); }catch(_){ }
});
window.addEventListener('unhandledrejection', function(e){
  try{ console.error('Promise rejection:', e.reason); }catch(_){ }
});

// ====== √âTAT GLOBAL (pas d'auth, tout en local) ======
var GENERAL_KEY='__ALL__';
var current = 'Momo'; // D√©marrage demand√©: Momo
var now = new Date();
var currentYear = now.getFullYear();
var currentMonth = now.getMonth();
var editing = false, editDay = null;
var people = ['Momo','Lucas','Sabri','Sofiane','Hamid','Adama','Iddir','Karim','Azeddine'];
var peopleData = {}; // Pas de seed: donn√©es vides par d√©faut
var monthNames = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];

// ====== JOURS F√âRI√âS (France) 2025 & 2026 ======
var HOLIDAYS_FR = {
  2025: {
    0:[1],            // 1 jan
    3:[21],           // Lundi de P√¢ques (21 avril 2025)
    4:[1,8,29],       // 1 mai, 8 mai, Ascension (29 mai 2025)
    5:[9],            // Lundi de Pentec√¥te (9 juin 2025)
    6:[14],           // 14 juillet
    7:[15],           // 15 ao√ªt (Assomption)
    10:[1,11],        // 1 nov, 11 nov
    11:[25]           // 25 d√©c
  },
  2026: {
    0:[1],
    3:[6],            // Lundi de P√¢ques (6 avril 2026)
    4:[1,8,14,25],    // 1 mai, 8 mai, Ascension (14 mai 2026), Lundi de Pentec√¥te (25 mai 2026)
    6:[14],
    7:[15],
    10:[1,11],
    11:[25]
  }
};
function isHoliday(y,m,d){
  var ys = HOLIDAYS_FR[y]; if(!ys) return false;
  var ms = ys[m]; if(!ms) return false;
  return ms.indexOf(d) > -1;
}

// ====== HELPERS ======
function ensureMonth(name,y,m){ if(!peopleData[name]) peopleData[name] = {}; if(!peopleData[name][y]) peopleData[name][y] = {}; if(!peopleData[name][y][m]) peopleData[name][y][m] = {days:{}}; return peopleData[name][y][m]; }
function colorOf(t){ return ({C:'var(--c)',P:'var(--p)',G:'var(--g)',R:'var(--r)'}[t]||'#999'); }
function weekNumber(dt){ var t=new Date(Date.UTC(dt.getFullYear(),dt.getMonth(),dt.getDate())); var d=t.getUTCDay()||7; t.setUTCDate(t.getUTCDate()+4-d); var y0=new Date(Date.UTC(t.getUTCFullYear(),0,1)); return Math.ceil((((t-y0)/86400000)+1)/7); }
function mondayOf(dt){ var d=(dt.getDay()+6)%7; var m=new Date(dt); m.setDate(dt.getDate()-d); return m; }
function parseTimeToHours(t){ var m=t.match(/^(\d{1,2})h(?:(\d{2}))?$/i); if(!m)return null; var H=parseInt(m[1],10), M=parseInt(m[2]||'0',10); return H+(M/60); }
function computeHoursFromDetail(detail){ var times=(detail.match(/\d{1,2}h\d{0,2}/g)||[]).map(parseTimeToHours).filter(function(v){return v!=null;}); var s=0; for(var i=0;i+1<times.length;i+=2) s+=times[i+1]-times[i]; return Math.round(s*2)/2; }
function showToast(t){ var el=document.getElementById('toast'); el.textContent=t||'OK'; el.style.display='block'; setTimeout(function(){ el.style.display='none'; },1500); }
var PLACE_WORDS=['Promenade','Colline','Grande Arche','Arche','Accueil','Gardiennage'];
function extractPlace(detail){ detail=(detail||'').trim(); if(!detail) return null; for(var i=0;i<PLACE_WORDS.length;i++){ var p=PLACE_WORDS[i]; var re=new RegExp('^\\s*'+p.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')+'\\b','i'); if(re.test(detail)) return p; } var m=detail.match(/^\s*([A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]+)\b/); return m ? (m[1].charAt(0).toUpperCase()+m[1].slice(1).toLowerCase()) : null; }
function findMates(opts){ var year=opts.year,month=opts.month,day=opts.day,place=opts.place,currentName=opts.currentName; if(!place) return []; var mates=[]; for(var i=0;i<people.length;i++){ var name=people[i]; if(name===currentName) continue; var store=peopleData[name] && peopleData[name][year] && peopleData[name][year][month]; var info=store && store.days && store.days[day]; if(!info) continue; var place2=extractPlace(info.detail||''); if(place2 && place2.toLowerCase()===place.toLowerCase()) mates.push(name); } return mates; }
// Formats horaires √† partir du "detail"
function formatIntervals(detail){
  var times=(detail.match(/\d{1,2}h\d{0,2}/g)||[]);
  var out=[]; for(var i=0;i+1<times.length;i+=2){ out.push(times[i]+' ‚Äì '+times[i+1]); }
  return out.join(' / ');
}
// Intervalles num√©riques [start,end] en heures d√©cimales
function intervals(detail){
  var times=(detail.match(/\d{1,2}h\d{0,2}/g)||[]).map(parseTimeToHours).filter(function(v){return v!=null;});
  var out=[]; for(var i=0;i+1<times.length;i+=2){ var a=times[i], b=times[i+1]; if(a!=null && b!=null && b>a) out.push([a,b]); }
  return out;
}
function overlaps(a,b){ return a[0] < b[1] && b[0] < a[1]; }

// Agr√©gation pour la vue g√©n√©rale (avec horaires par personne)
function aggregateDay(year, month, day){
  var byPlace = {};
  for(var i=0;i<people.length;i++){
    var name=people[i];
    var store=peopleData[name] && peopleData[name][year] && peopleData[name][year][month];
    var info=store && store.days && store.days[day];
    if(!info) continue;
    var place=extractPlace(info.detail||'');
    if(!place) continue;
    if(!byPlace[place]) byPlace[place]=[];
    byPlace[place].push({
      name:name,
      hours:info.hours,
      detail:info.detail||'',
      intervals:formatIntervals(info.detail||'')
    });
  }
  return byPlace;
}

// ====== LOCALSTORAGE ======
var STORAGE_KEY='planning_simple_v1';
function saveLocal(){ var data={people:people,peopleData:peopleData,current:current,currentYear:currentYear,currentMonth:currentMonth}; try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){ console.warn('localStorage save failed', e); } }
function loadLocal(){ try{ var s=JSON.parse(localStorage.getItem(STORAGE_KEY)||'null'); if(!s) return false; people=s.people||people; Object.assign(peopleData, s.peopleData||{}); // On force quand m√™me l'arriv√©e sur Momo
 current='Momo'; currentYear=s.currentYear||currentYear; currentMonth=s.currentMonth||currentMonth; return true; }catch(e){ return false; } }

// ====== RENDER ======
var peopleEl=document.getElementById('people');
var btnGeneral=document.getElementById('btnGeneral');
function renderSidebar(){ if(!peopleEl) return; peopleEl.innerHTML=''; var colors=['#9bd0ff','#ffd28a','#8ec5ff','#c4f6c1','#ffb4b4','#d7c7ff','#ffe69b','#a0e9dd','#fbd1ff']; for(var i=0;i<people.length;i++){ (function(name,idx){ var el=document.createElement('div'); el.className='person'+(name===current?' active':''); el.innerHTML='<span class="badge" style="background:'+colors[idx%colors.length]+'"></span>'+name; el.onclick=function(){ current=name; document.querySelectorAll('.person').forEach(function(n){n.classList.remove('active')}); el.classList.add('active'); if(btnGeneral) btnGeneral.classList.remove('active'); saveLocal(); render(); }; peopleEl.appendChild(el); })(people[i],i); }
  if(btnGeneral){ if(current===GENERAL_KEY) btnGeneral.classList.add('active'); else btnGeneral.classList.remove('active'); }
}

if(btnGeneral){ btnGeneral.onclick=function(){ current=GENERAL_KEY; document.querySelectorAll('.person').forEach(function(n){n.classList.remove('active')}); btnGeneral.classList.add('active'); render(); }; }

function isGeneral(){ return current===GENERAL_KEY; }

function render(){
  updateEditBadge();
  var who=document.getElementById('who');
  if(who) who.textContent = isGeneral()? 'Planning g√©n√©rale' : current;
  var monthLabel=document.getElementById('monthLabel'); if(monthLabel) monthLabel.textContent=monthNames[currentMonth]+' '+currentYear;

  var cal=document.getElementById('cal'); if(!cal) return; cal.innerHTML='';
  ['lun','mar','mer','jeu','ven','sam','dim'].forEach(function(d){ var el=document.createElement('div'); el.className='dow'; el.textContent=d; cal.appendChild(el); });
  var first=new Date(currentYear,currentMonth,1), offset=(first.getDay()+6)%7, dim=new Date(currentYear,currentMonth+1,0).getDate();
  for(var i=0;i<offset;i++){ var e=document.createElement('div'); e.className='card empty'; cal.appendChild(e); }

  if(isGeneral()){
    // Vue agr√©g√©e: par lieu -> liste noms + horaires
    for(var day=1; day<=dim; day++){
      var card=document.createElement('div'); card.className='card'; card.setAttribute('data-day',day);
      var dd=document.createElement('div'); dd.className='date'; dd.textContent=String(day).padStart(2,'0'); card.appendChild(dd);

      if(isHoliday(currentYear,currentMonth,day)){
        var h=document.createElement('div'); h.className='holiday'; h.textContent='F√©ri√©'; card.appendChild(h);
      }

      var map=aggregateDay(currentYear,currentMonth,day);
      var places=Object.keys(map);
      if(places.length){
        places.sort(function(a,b){ return a.localeCompare(b,'fr'); });
        places.forEach(function(place){
          var list = map[place].map(function(it){ 
            var hoursPart = (it.hours!=null && it.hours!=='' ? ' ¬∑ '+String(it.hours).replace('.',',')+' h' : '');
            var iv = it.intervals || '';
            var suffix = iv ? ' ('+iv+hoursPart+')' : hoursPart;
            return it.name + suffix;
          }).join(', ');
          var pill=document.createElement('div'); pill.className='pill place'; pill.textContent=place+' ‚Äî '+list;
          card.appendChild(pill);
        });
      }
      card.onclick=(function(d){ return function(){ openInfoGeneral(d); }; })(day);
      cal.appendChild(card);
    }
    var filled=offset+dim, rest=(7-(filled%7))%7; for(var r=0;r<rest;r++){ var ee=document.createElement('div'); ee.className='card empty'; cal.appendChild(ee); }
    renderTotalsGeneral();
    updatePrintHeader();
    return;
  }

  // Vue personne
  var store=ensureMonth(current,currentYear,currentMonth);
  var days=store.days;
  for(var day=1; day<=dim; day++){
    var card=document.createElement('div'); card.className='card'; card.setAttribute('data-day',day);
    var dd=document.createElement('div'); dd.className='date'; dd.textContent=String(day).padStart(2,'0'); card.appendChild(dd);

    if(isHoliday(currentYear,currentMonth,day)){
      var h=document.createElement('div'); h.className='holiday'; h.textContent='F√©ri√©'; card.appendChild(h);
    }

    var info=days[day];
    if(info){
      card.classList.add('work');
      var pill=document.createElement('div'); pill.className='pill'; pill.setAttribute('data-type',info.type); pill.style.background=colorOf(info.type);
      var labelType = (info.type==='R'?'Cong√©':info.type);
      pill.innerHTML='<span>'+labelType+'</span> <small>'+String(info.hours).replace('.',',')+' h</small>';
      pill.title=info.detail||'';
      card.appendChild(pill);
      if(info.note){ var n=document.createElement('div'); n.className='note'; n.textContent=info.note; card.appendChild(n); }
      var place=extractPlace(info.detail||'');
      if(place){
        var mates=findMates({year:currentYear,month:currentMonth,day:day,place:place,currentName:current});
        if(mates.length){ var mEl=document.createElement('div'); mEl.className='mates'; mEl.textContent='Avec : '+mates.join(', '); card.appendChild(mEl); }
      }
    } else if(editing){
      var plus=document.createElement('div'); plus.className='pill'; plus.style.background='#27406f'; plus.style.color='#fff'; plus.textContent='+ Ajouter'; plus.onclick=(function(d){ return function(ev){ ev.stopPropagation(); openEditor(d); }; })(day); card.appendChild(plus);
    }
    card.onclick=(function(d){ return function(){ openInfo(d); }; })(day);
    cal.appendChild(card);
  }
  var filled2=offset+dim, rest2=(7-(filled2%7))%7; for(var r2=0;r2<rest2;r2++){ var ee2=document.createElement('div'); ee2.className='card empty'; cal.appendChild(ee2); }
  renderTotals(days);
  updatePrintHeader();
}

function renderTotals(days){ var totals=document.getElementById('totals'); if(!totals) return; totals.innerHTML=''; var monthSum=0; Object.values(days).forEach(function(v){ monthSum+=Number(v.hours||0); }); totals.appendChild(box('Total mois',monthSum.toFixed(2).replace('.',',')+' h')); var weeks={}, dim=new Date(currentYear,currentMonth+1,0).getDate(); for(var d=1; d<=dim; d++){ if(days[d]){ var w=weekNumber(new Date(currentYear,currentMonth,d)); weeks[w]=(weeks[w]||0)+Number(days[d].hours||0); } } Object.keys(weeks).sort(function(a,b){return a-b;}).forEach(function(w){ totals.appendChild(box('Sem. '+w,weeks[w].toFixed(2).replace('.',',')+' h')); }); function box(t,v){ var el=document.createElement('div'); el.className='box'; el.innerHTML='<h3>'+t+'</h3><div>'+v+'</div>'; return el; } }

function renderTotalsGeneral(){ var totals=document.getElementById('totals'); if(!totals) return; totals.innerHTML=''; var dim=new Date(currentYear,currentMonth+1,0).getDate();
  var uniquePlaces=new Set();
  for(var d=1; d<=dim; d++){
    var map=aggregateDay(currentYear,currentMonth,d);
    Object.keys(map).forEach(function(p){ uniquePlaces.add(p); });
  }
  var el=document.createElement('div'); el.className='box'; el.innerHTML='<h3>Sites du mois</h3><div>'+uniquePlaces.size+'</div>';
  totals.appendChild(el);
}

function updatePrintHeader(){ var phPerson=document.getElementById('phPerson'); if(phPerson) phPerson.textContent = isGeneral()? 'Planning g√©n√©rale' : current; var phMonth=document.getElementById('phMonth'); if(phMonth) phMonth.textContent=monthNames[currentMonth]+' '+currentYear; var phDate=document.getElementById('phDate'); if(phDate) phDate.textContent=new Date().toLocaleString('fr-FR'); }

function updateEditBadge(){ var b=document.getElementById('editBadge'); if(!b) return; b.style.display = (editing && !isGeneral()) ? 'block' : 'none'; }

// ====== V√âRIF CONFLITS (lieu + chevauchement horaires) ======
function findConflicts(params){
  var name = params.name, year=params.year, month=params.month, day=params.day, detail=params.detail;
  var place = extractPlace(detail||'');
  if(!place) return null;
  var newIntervals = intervals(detail||'');
  if(!newIntervals.length) return null; // si pas d‚Äôhoraires, on laisse passer
  for(var i=0;i<people.length;i++){
    var other = people[i];
    if(other===name) continue;
    var store=peopleData[other] && peopleData[other][year] && peopleData[other][year][month];
    var info=store && store.days && store.days[day];
    if(!info) continue;
    var p2=extractPlace(info.detail||'');
    if(!p2 || p2.toLowerCase()!==place.toLowerCase()) continue;
    var ints2 = intervals(info.detail||'');
    for(var a=0;a<newIntervals.length;a++){
      for(var b=0;b<ints2.length;b++){
        if(overlaps(newIntervals[a],ints2[b])){
          return {with: other, place: place};
        }
      }
    }
  }
  return null;
}

// ====== √âDITION ======
var mb=document.getElementById('mb'); var fType=document.getElementById('fType'), fHours=document.getElementById('fHours'), fDetail=document.getElementById('fDetail'), fNote=document.getElementById('fNote');
function openEditor(day){ if(isGeneral()) return; editDay=day; var d=ensureMonth(current,currentYear,currentMonth).days[day]||{type:'C',hours:'',detail:'',note:''}; document.getElementById('mTitle').textContent=String(day).padStart(2,'0')+'/'+String(currentMonth+1).padStart(2,'0')+'/'+currentYear+' ‚Äî '+current; fType.value=d.type||'C'; fHours.value=(d.hours!=null?d.hours:''); fDetail.value=d.detail||''; fNote.value=d.note||''; mb.style.display='flex'; }
function closeEditor(){ mb.style.display='none'; editDay=null; }
var btnClose=document.getElementById('btnClose'); if(btnClose) btnClose.onclick=closeEditor;
Array.prototype.forEach.call(document.querySelectorAll('.chip[data-preset]'), function(ch){ ch.onclick=function(){ var p=JSON.parse(ch.getAttribute('data-preset')); fType.value=p.type||'C'; fDetail.value=p.detail||''; if(p.autoHours&&p.detail){ var h=computeHoursFromDetail(p.detail); fHours.value=(isFinite(h)?h:0); } }; });
var copyPrev=document.getElementById('copyPrev'); if(copyPrev) copyPrev.onclick=function(){ if(editDay==null) return; var prev=ensureMonth(current,currentYear,currentMonth).days[editDay-1]; if(prev){ fType.value=prev.type; fHours.value=prev.hours; fDetail.value=prev.detail||''; fNote.value=prev.note||''; } };

// Enregistrer (avec blocage si conflit)
var btnSave=document.getElementById('btnSave'); if(btnSave) btnSave.onclick=function(){
  if(editDay==null) return;
  var detail = (fDetail.value||'').trim();
  var conflict = findConflicts({name:current, year:currentYear, month:currentMonth, day:editDay, detail:detail});
  if(conflict){
    alert('‚õî Conflit: '+conflict.with+' est d√©j√† √† '+conflict.place+' sur des horaires qui se chevauchent. Modifie les heures ou le lieu.');
    return;
  }
  ensureMonth(current,currentYear,currentMonth).days[editDay]={type:fType.value,hours:Number(fHours.value||0),detail:detail,note:fNote.value.trim()};
  saveLocal(); closeEditor(); render();
};

// Supprimer
var btnDel=document.getElementById('btnDel'); if(btnDel) btnDel.onclick=function(){ if(editDay==null) return; delete ensureMonth(current,currentYear,currentMonth).days[editDay]; saveLocal(); closeEditor(); render(); };

// Remplir la semaine (bloque si 1 conflit d√©tect√©)
var btnWeek=document.getElementById('btnWeek'); if(btnWeek) btnWeek.onclick=function(){
  if(editDay==null) return;
  var dt=new Date(currentYear,currentMonth,editDay), mon=mondayOf(dt), dim=new Date(currentYear,currentMonth+1,0).getDate();
  var payload={type:fType.value,hours:Number(fHours.value||0),detail:(fDetail.value||'').trim(),note:fNote.value.trim()};
  // check
  for(var i=0;i<7;i++){
    var d=mon.getDate()+i; if(d<1||d>dim) continue;
    var c=findConflicts({name:current, year:currentYear, month:currentMonth, day:d, detail:payload.detail});
    if(c){ alert('‚õî Conflit le '+String(d).padStart(2,'0')+'/'+String(currentMonth+1).padStart(2,'0')+': '+c.with+' est d√©j√† √† '+c.place+' sur des horaires qui se chevauchent.'); return; }
  }
  var store=ensureMonth(current,currentYear,currentMonth).days;
  for(var i2=0;i2<7;i2++){
    var dd=mon.getDate()+i2; if(dd>=1&&dd<=dim){ store[dd]=Object.assign({},payload); }
  }
  saveLocal(); closeEditor(); render();
};

// Appliquer sur une plage (bloque si 1 conflit d√©tect√©)
var btnRange=document.getElementById('btnRange'); if(btnRange) btnRange.onclick=function(){
  var ans=prompt('Appliquer du jour X au jour Y (ex: 5-12) :','');
  if(!ans) return;
  var m=ans.match(/^\s*(\d{1,2})\s*[-‚Äì]\s*(\d{1,2})\s*$/);
  if(!m) return alert('Format invalide. Exemple : 5-12');
  var a=parseInt(m[1],10), b=parseInt(m[2],10);
  if(a>b){ var tmp=a; a=b; b=tmp; }
  var dim=new Date(currentYear,currentMonth+1,0).getDate();
  a=Math.max(1,Math.min(dim,a)); b=Math.max(1,Math.min(dim,b));
  var payload={type:fType.value,hours:Number(fHours.value||0),detail:(fDetail.value||'').trim(),note:fNote.value.trim()};
  for(var d=a; d<=b; d++){
    var c=findConflicts({name:current, year:currentYear, month:currentMonth, day:d, detail:payload.detail});
    if(c){ alert('‚õî Conflit le '+String(d).padStart(2,'0')+'/'+String(currentMonth+1).padStart(2,'0')+': '+c.with+' est d√©j√† √† '+c.place+' sur des horaires qui se chevauchent.'); return; }
  }
  var store=ensureMonth(current,currentYear,currentMonth).days;
  for(var d2=a; d2<=b; d2++){ store[d2]=Object.assign({},payload); }
  saveLocal(); closeEditor(); render();
};

// ====== INFO ======
var infoBack=document.getElementById('infoBack'), infoTitle=document.getElementById('infoTitle'), infoBody=document.getElementById('infoBody'), infoClose=document.getElementById('infoClose'), infoEdit=document.getElementById('infoEdit');
var infoDay=null;
function openInfo(day){ if(isGeneral()){ openInfoGeneral(day); return; } infoDay=day; var data=ensureMonth(current,currentYear,currentMonth).days[day]||null; var dateStr=String(day).padStart(2,'0')+'/'+String(currentMonth+1).padStart(2,'0')+'/'+currentYear; infoTitle.textContent=dateStr+' ‚Äî '+current; infoBody.innerHTML=''; if(!data){ infoBody.innerHTML='<div>Aucune donn√©e pour ce jour.</div>'; } else { var place=extractPlace(data.detail||''); var mates=place? findMates({year:currentYear,month:currentMonth,day:day,place:place,currentName:current}) : []; var preciseList=(data.detail||'').match(/\d{1,2}h\d{0,2}/g)||[]; var precise=preciseList.length? preciseList.join(' ‚Äî ') : '‚Äî'; var band=document.createElement('div'); band.style.display='flex'; band.style.alignItems='center'; band.style.gap='10px'; band.style.background='#0c1a33'; band.style.border='1px solid #2a3d6d'; band.style.borderRadius='12px'; band.style.padding='10px 12px'; var labelType=(data.type==='R'?'Cong√©':data.type); band.innerHTML='<div style="font-size:22px;font-weight:900">‚è∞ '+precise+'</div><div style="margin-left:auto;font-weight:800;padding:6px 10px;border-radius:999px;background:'+colorOf(data.type)+'">'+labelType+' ¬∑ '+(data.hours!=null?data.hours:'-')+' h</div>'; infoBody.appendChild(band); var items=[["Lieu",place||'‚Äî'],["D√©tail",data.detail||'‚Äî'],["Note",data.note||'‚Äî'],["Avec",mates.length?mates.join(', '):'‚Äî']]; items.forEach(function(pair){ var k=pair[0],v=pair[1]; var row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='160px 1fr'; row.style.gap='8px'; row.innerHTML='<div style="color:#9aa3b2;font-weight:700">'+k+'</div><div>'+v+'</div>'; infoBody.appendChild(row); }); } if(infoEdit) infoEdit.style.display = editing? 'inline-block' : 'none'; infoBack.style.display='flex'; }

function openInfoGeneral(day){ infoDay=day; var dateStr=String(day).padStart(2,'0')+'/'+String(currentMonth+1).padStart(2,'0')+'/'+currentYear; infoTitle.textContent=dateStr+' ‚Äî Planning g√©n√©rale'; infoBody.innerHTML=''; var map=aggregateDay(currentYear,currentMonth,day); var places=Object.keys(map); if(places.length===0){ infoBody.innerHTML='<div>Aucune affectation ce jour.</div>'; } else { places.sort(function(a,b){ return a.localeCompare(b,'fr'); }); places.forEach(function(place){ var row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='160px 1fr'; row.style.gap='8px'; var list=map[place].map(function(it){ var hoursPart=(it.hours!=null && it.hours!==''?' ¬∑ '+String(it.hours).replace('.',',')+' h':''); var iv=it.intervals||''; var suffix = iv ? ' ('+iv+hoursPart+')' : hoursPart; return it.name+suffix; }).join(', '); row.innerHTML='<div style="color:#9aa3b2;font-weight:700">'+place+'</div><div>'+list+'</div>'; infoBody.appendChild(row); }); }
  if(infoEdit) infoEdit.style.display='none'; infoBack.style.display='flex'; }

if(infoClose){ infoClose.onclick=function(){ infoBack.style.display='none'; infoDay=null; }; }
if(infoBack){ infoBack.addEventListener('click',function(e){ if(e.target===infoBack){ infoBack.style.display='none'; infoDay=null; } }); }
if(infoEdit){ infoEdit.onclick=function(){ if(infoDay!=null && !isGeneral()){ infoBack.style.display='none'; openEditor(infoDay); } }; }

// ====== Mois ======
var mpb=document.getElementById('mpb'), monthGrid=document.getElementById('monthGrid'), curYearEl=document.getElementById('curYear');
var monthLabelEl=document.getElementById('monthLabel');
if(monthLabelEl){ monthLabelEl.onclick=function(){ curYearEl.textContent=currentYear; monthGrid.innerHTML=''; monthNames.forEach(function(n,i){ var b=document.createElement('button'); b.textContent=n[0].toUpperCase()+n.slice(1); b.onclick=function(){ currentMonth=i; mpb.style.display='none'; saveLocal(); render(); }; monthGrid.appendChild(b); }); mpb.style.display='flex'; }; }
var mpClose=document.getElementById('mpClose'); if(mpClose){ mpClose.onclick=function(){ mpb.style.display='none'; }; }
if(mpb){ mpb.addEventListener('click',function(e){ if(e.target===mpb){ mpb.style.display='none'; } }); }

// ====== People manager ======
var peopleModal=document.getElementById('peopleModal');
var pmList=document.getElementById('pmList');
var pmAdd=document.getElementById('pmAdd');
var pmSave=document.getElementById('pmSave');
var pmCancel=document.getElementById('pmCancel');
var btnPeople=document.getElementById('btnPeople');
if(btnPeople){ btnPeople.onclick=function(){ pmList.innerHTML=''; people.forEach(function(name,idx){ var row=document.createElement('div'); row.style.display='grid'; row.style.gridTemplateColumns='1fr auto'; row.style.gap='8px'; row.style.margin='6px 0'; row.innerHTML='<input value="'+name+'" data-idx="'+idx+'"/> <button class="danger" data-del="'+idx+'">Supprimer</button>'; pmList.appendChild(row); }); pmList.onclick=function(e){ var d=e.target && e.target.getAttribute('data-del'); if(d!=null){ var i=parseInt(d,10); people.splice(i,1); btnPeople.click(); } }; peopleModal.style.display='flex'; }; }
if(pmAdd){ pmAdd.onclick=function(){ var newName=prompt('Nouveau nom :'); if(!newName) return; if(people.indexOf(newName)===-1) people.push(newName); ensureMonth(newName,currentYear,currentMonth); if(btnPeople) btnPeople.click(); }; }
if(pmSave){ pmSave.onclick=function(){ var inputs=[].slice.call(pmList.querySelectorAll('input[data-idx]')); var newPeople=inputs.map(function(i){return i.value.trim();}).filter(Boolean); if(!newPeople.length) return alert('La liste ne peut pas √™tre vide.'); people=Array.from(new Set(newPeople)); saveLocal(); peopleModal.style.display='none'; renderSidebar(); render(); showToast('Noms mis √† jour'); }; }
if(pmCancel){ pmCancel.onclick=function(){ peopleModal.style.display='none'; }; }

// ====== Toolbar ======
var btnEdit=document.getElementById('btnEdit'); if(btnEdit){ btnEdit.onclick=function(){ if(isGeneral()){ showToast('√âdition indisponible en vue g√©n√©rale'); return; } editing=!editing; btnEdit.textContent = editing ? "D√©sactiver l‚Äô√©dition" : "Activer l‚Äô√©dition"; render(); }; }
var btnPdf=document.getElementById('btnPdf'); if(btnPdf){ btnPdf.onclick=function(){ updatePrintHeader(); window.print(); }; }
var btnSaveAll=document.getElementById('btnSaveAll'); if(btnSaveAll){ btnSaveAll.onclick=function(){ saveLocal(); showToast('Enregistr√© ‚úÖ'); }; }
var btnBackup=document.getElementById('btnBackup'); if(btnBackup){ btnBackup.onclick=function(){ var blob=new Blob([JSON.stringify({people:people,peopleData:peopleData},null,2)],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='planning_backup_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(a.href); }; }
var btnImport=document.getElementById('btnImport'); var fileImport=document.getElementById('fileImport'); if(btnImport && fileImport){ btnImport.onclick=function(){ fileImport.click(); }; fileImport.onchange=function(){ var f=fileImport.files[0]; if(!f) return; var rd=new FileReader(); rd.onload=function(){ try{ var data=JSON.parse(rd.result); if(data.people) people=data.people; if(data.peopleData) peopleData=data.peopleData; saveLocal(); renderSidebar(); render(); showToast('Import r√©ussi'); }catch(e){ alert('Fichier invalide'); } }; rd.readAsText(f); }; }

// Bouton Tout effacer
var btnReset=document.getElementById('btnReset');
if(btnReset){ btnReset.onclick=function(){
  var ok=confirm('‚ö†Ô∏è Cette action est irr√©versible. Voulez-vous vraiment TOUT effacer (plannings et noms) ?');
  if(!ok) return;
  try{ localStorage.removeItem(STORAGE_KEY); }catch(_){}
  try{ localStorage.removeItem('planning_v1'); localStorage.removeItem('planning_simple'); }catch(_){}
  var DEFAULT_PEOPLE=['Momo','Lucas','Sabri','Sofiane','Hamid','Adama','Iddir','Karim','Azeddine'];
  people=DEFAULT_PEOPLE.slice();
  peopleData={};
  current='Momo';
  editing=false;
  renderSidebar();
  var g=document.getElementById('btnGeneral'); if(g) g.classList.remove('active');
  render();
  showToast('Donn√©es effac√©es');
  setTimeout(function(){ location.reload(); }, 120);
}; }

// ====== Tests rapides
(function runDevTests(){
  try{
    console.info('[Tests] start');
    console.assert(extractPlace('Colline 7h/12h')==='Colline','extract Colline');
    console.assert(parseTimeToHours('13h30')===13.5,'parse 13h30');
    console.assert(computeHoursFromDetail('7h/12h - 13h30/21h30')===13,'hours 13');
    var ints=intervals('7h/12h - 13h30/21h30'); console.assert(ints.length===2 && ints[0][0]===7 && ints[0][1]===12,'intervals ok');
    console.info('[Tests] ok');
  }catch(e){ console.warn('[Tests] fail',e); }
})();

// ====== BOOT ======
(function init(){
  loadLocal(); // charge si dispo, mais garde Momo comme personne courante
  renderSidebar();
  render();
})();
</script>
</body>
</html>

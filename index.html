<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MB Gardiennage ‚Äî Planning s√©curis√©</title>

<!-- Firebase SDK (compat = simple pour page HTML) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#0b1220; --text:#e5e7eb; --muted:#9aa3b2;
    --card:#0f172a; --border:#1f2a44; --shadow:0 10px 30px rgba(0,0,0,.35);
    --c:#1e88ff; --p:#08a86b; --g:#ff8a2a; --r:#8b5cf6;
    --brand:#6aa3ff; --accent:#2b5cff; --danger:#ef4444;
    --sidebar:#0f172a; --sidebar-border:#1f2a44; --sidebar-hover:#162746;
    --chip:#101b33; --chip-bd:#2c3b63;
    --grad: radial-gradient(1200px 600px at 0% 0%, #102041, #0b1220 60%);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

  /* ===== Accueil ===== */
  #home{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--grad);padding:24px}
  .home-card{width:100%;max-width:840px;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:22px}
  .home-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .home-title{font-weight:900;font-size:20px;color:#cfe0ff}
  .home-sub{color:var(--muted);margin:6px 0 14px}
  .home-actions{display:flex;gap:8px}
  .btn{background:#13213d;border:1px solid #2a3d6d;color:#e5e7eb;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
  .btn:hover{background:#142a57}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.ghost{background:transparent}
  .team-tile{margin:6px 0 14px;background:#0e1b33;border:1px solid #253a6b;padding:16px;border-radius:16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;box-shadow:var(--shadow)}
  .team-tile:hover{background:#11244a}
  .team-title{font-weight:900}
  .team-chip{background:#142a57;border:1px solid #2b4a8a;padding:8px 10px;border-radius:12px}
  .team-section{display:none}
  .sec-title{margin:0 0 10px;font-size:16px;color:#bcd7ff}
  .home-grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
  @media(min-width:720px){.home-grid{grid-template-columns:repeat(4,1fr)}}
  .person-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;transition:transform .12s ease, background .12s ease}
  .person-card:hover{transform:translateY(-1px);background:var(--sidebar-hover)}
  .avatar{width:64px;height:64px;border-radius:50%;border:2px solid var(--border);background:#17345f;display:flex;align-items:center;justify-content:center;font-weight:900;overflow:hidden}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .pname{font-weight:900}
  .pwd-hint{font-size:12px;color:var(--muted)}

  /* ===== App ===== */
  .app{display:grid;grid-template-columns:270px 1fr;min-height:100vh}
  .side{background:var(--sidebar);border-right:1px solid var(--sidebar-border);padding:16px 12px}
  .logo{font-weight:900;font-size:18px;letter-spacing:.2px;color:#cfe0ff;margin-bottom:12px}
  .people{display:flex;flex-direction:column;gap:6px}
  .person{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .person:hover{background:var(--sidebar-hover)}
  .person.active{outline:2px solid #2b5cff66}
  .badge{width:10px;height:10px;border-radius:50%}
  .lock{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}

  header{position:sticky;top:0;background:var(--bg);z-index:15;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 12px 10px}
  h1{margin:0;font-size:20px}
  #monthLabel{cursor:pointer;border-bottom:2px dashed transparent}
  #monthLabel:hover{border-color:#2b5cff}
  .muted{color:var(--muted)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  button{background:#13213d;border:1px solid #2a3d6d;color:#e5e7eb;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
  button:hover{background:#142a57}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.danger{border-color:#7f1d1d;background:#3f1d1d;color:#fecaca}
  button[disabled]{opacity:.6;cursor:not-allowed}
  #menuBtn{display:none;border-radius:10px;padding:8px 10px}

  .wrap{max-width:1100px;margin:0 auto 40px;padding:0 12px}
  .legend{display:flex;gap:12px;flex-wrap:wrap;margin:6px 0 12px}
  .tag{display:inline-flex;gap:8px;align-items:center;font-size:13px;color:#94a3b8}
  .sw{width:14px;height:14px;border-radius:4px;display:inline-block}
  .totals{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .box{background:#0f172a;border:1px solid #1f2a44;border-radius:12px;padding:10px 14px;box-shadow:var(--shadow)}
  .box h3{margin:0 0 4px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .box div{font-size:18px;font-weight:900}

  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .dow{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;text-align:center}
  .card{background:#0f172a;border:1px solid #1f2a44;border-radius:14px;padding:10px;min-height:96px;position:relative;box-shadow:var(--shadow);cursor:pointer;transition:transform .08s ease}
  .card:hover{transform:translateY(-1px)}
  .date{position:absolute;top:8px;left:10px;font-weight:900;font-size:13px;color:#94a3b8}
  .pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;padding:6px 10px;border-radius:999px;font-weight:900;margin-top:22px;width:max-content;color:#fff;border:none}
  .pill[data-type="C"]{background:var(--c)} .pill[data-type="P"]{background:var(--p)}
  .pill[data-type="G"]{background:var(--g)} .pill[data-type="R"]{background:var(--r)}
  .note{font-size:12px;color:#a78bfa;margin-top:6px}
  .empty{opacity:.25}
  footer{color:var(--muted);text-align:center;padding:14px}
  .small{font-size:11px}

  /* Modals */
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{background:var(--chip);border:1px solid var(--chip-bd);border-radius:999px;padding:7px 10px;font-weight:800;cursor:pointer}
  .chip:hover{background:#182a55}
  .modal-back{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:30}
  .modal{background:#0f172a;max-width:620px;width:100%;border-radius:16px;padding:14px;border:1px solid #1f2a44;box-shadow:0 22px 48px rgba(0,0,0,.5)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:#cbd5e1;font-weight:700}
  input,select{width:100%;padding:10px;border:1px solid #2a3d6d;border-radius:10px;font-size:14px;background:#091124;color:#e5e7eb}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}

  /* Drawer mobile */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:25}
  .side.drawer{position:fixed;top:0;left:0;height:100vh;width:86vw;max-width:320px;transform:translateX(-100%);transition:transform .25s ease;z-index:30;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .side.drawer.open{transform:translateX(0)}
  body.menu-open{overflow:hidden}

  /* Mobile */
  @media (max-width:880px){
    .app{grid-template-columns:1fr}
    .side{position:static}
    .side.drawer{display:block}
    #menuBtn{display:inline-block}
    .wrap{padding:0 10px}
    .calendar{grid-template-columns:repeat(2,1fr);gap:8px}
    .card{min-height:88px;padding:10px}
    .pill{padding:8px 12px;font-size:14px}
    .chips .chip{padding:9px 12px;font-size:14px}
    h1{font-size:18px}
  }
  @media (max-width:390px){
    .calendar{gap:6px}
    .card{min-height:84px}
    .pill{font-size:13px}
  }

  .toast{position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none;z-index:50}
  @media print{
    #home,.side,header .toolbar,#menuBtn,#overlay,.modal-back,.small,.toast{display:none}
    .card{break-inside:avoid}
    .card.work .date{font-weight:900}
    .card.work .pill{font-weight:900}
    body{background:#fff}
  }
</style>
</head>
<body>

<!-- ===== ACCUEIL ===== -->
<section id="home">
  <div class="home-card">
    <div class="home-header">
      <div>
        <div class="home-title">MB Gardiennage ‚Äî Planning</div>
        <div class="home-sub">Bienvenue sur l‚Äôespace de consultation des plannings de l‚Äôentreprise <b>MB Gardiennage</b>.</div>
      </div>
      <div class="home-actions">
        <button class="btn" id="adminBtn">Admin</button>
        <button class="btn ghost" id="aboutBtn" title="Infos">‚ÑπÔ∏è</button>
      </div>
    </div>

    <div id="teamBtn" class="team-tile">
      <span class="team-title">√âquipe I√âSEG</span>
      <span class="team-chip">Afficher les noms ‚ñ∂</span>
    </div>

    <div id="teamSection" class="team-section">
      <h3 class="sec-title">√âquipe I√âSEG</h3>
      <div class="home-grid" id="homeGrid"></div>
    </div>

    <p class="pwd-hint" style="margin-top:10px">Chaque personne a son mot de passe (Momo=<b>1</b>, Lucas=<b>2</b>, ‚Ä¶, Karim=<b>8</b>). Admin = <b>securite</b>.</p>
  </div>
</section>

<!-- ===== APPLICATION ===== -->
<div id="app" class="app" style="display:none">
  <aside class="side">
    <div class="logo">üóìÔ∏è Planning</div>
    <div class="people" id="people"></div>
    <div class="lock" id="lockInfo">üîí √âdition verrouill√©e</div>
    <div style="margin-top:14px;color:var(--muted);font-size:12px">Astuce : clique le <b>mois</b> pour changer.</div>
  </aside>

  <main>
    <header>
      <button id="menuBtn" aria-label="Ouvrir le menu">‚ò∞</button>
      <h1><span id="monthLabel">ao√ªt 2025</span> ‚Äî <span class="muted" id="who">Sabri</span></h1>
      <div class="toolbar">
        <button id="btnHome">Accueil</button>
        <button id="btnLogout" class="danger">D√©connexion</button>
        <button id="btnPdf">PDF</button>
        <button id="btnEdit" disabled>Activer l‚Äô√©dition</button>
        <button id="btnPeople" disabled>Ajout & modification</button>
        <button id="btnSaveAll">Enregistrer</button>
        <button id="btnBackup">Export JSON</button>
        <button id="btnImport">Import JSON</button>
        <input type="file" id="fileImport" accept="application/json" hidden>
      </div>
    </header>

    <div class="wrap">
      <div class="legend">
        <span class="tag"><span class="sw" style="background:var(--c)"></span> C</span>
        <span class="tag"><span class="sw" style="background:var(--p)"></span> P</span>
        <span class="tag"><span class="sw" style="background:var(--g)"></span> G</span>
        <span class="tag"><span class="sw" style="background:var(--r)"></span> Ronde/Fin sp√©ciale</span>
      </div>
      <div id="totals" class="totals"></div>
      <div id="cal" class="calendar" aria-live="polite"></div>
      <p class="small">Derni√®re mise √† jour : <span id="now"></span></p>
    </div>
    <footer>Jours travaill√©s en <b>gras</b> sur le PDF. Admin : <b>securite</b>.</footer>
  </main>
</div>

<!-- ===== MODALE JOUR ===== -->
<div class="modal-back" id="mb">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <h2 id="mTitle">Modifier</h2>
    <div class="chips">
      <span class="chip" data-preset='{"type":"P","detail":"Promenade 7h/13h30 - 15h/21h30","autoHours":true}'>Promenade 7h/13h30 - 15h/21h30</span>
      <span class="chip" data-preset='{"type":"P","detail":"Promenade 9h/15h - 16h30/21h30","autoHours":true}'>Promenade 9h/15h - 16h30/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h/12h - 13h30/21h30","autoHours":true}'>Colline 7h/12h - 13h30/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 9h/13h30 - 15h/21h30","autoHours":true}'>Colline 9h/13h30 - 15h/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h30/12h - 13h/19h30","autoHours":true}'>Colline 7h30/12h - 13h/19h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h30/13h - 14h/21h30","autoHours":true}'>Colline 7h30/13h - 14h/21h30</span>
      <span class="chip" data-preset='{"type":"G","detail":"Grande Arche 7h30/12h - 13h30/21h","autoHours":true}'>Grande Arche 7h30/12h - 13h30/21h</span>
      <span class="chip" id="copyPrev">Copier la veille</span>
    </div>
    <div class="row">
      <div>
        <label>Type</label>
        <select id="fType">
          <option value="C">C</option>
          <option value="P">P</option>
          <option value="G">G</option>
          <option value="R">R (Ronde/Fin sp√©ciale)</option>
        </select>
      </div>
      <div>
        <label>Heures</label>
        <input id="fHours" type="number" step="0.5" min="0" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>D√©tail</label>
        <input id="fDetail" placeholder="7h‚Äì12 / 13h30‚Äì21h30" />
      </div>
      <div>
        <label>Note</label>
        <input id="fNote" placeholder="Fin 19h" />
      </div>
    </div>
    <div class="actions">
      <button id="btnWeek">Remplir la semaine</button>
      <button id="btnRange">Appliquer sur une plage</button>
      <button id="btnDel" class="danger">Supprimer</button>
      <button id="btnClose">Fermer</button>
      <button id="btnSave" class="primary">Enregistrer</button>
    </div>
  </div>
</div>

<!-- S√©lecteur de mois -->
<div class="modal-back" id="mpb">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Choisir un mois ‚Äî <span id="curYear"></span></h3>
    <div class="mp-grid" id="monthGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px"></div>
    <div class="actions"><button id="mpClose">Fermer</button></div>
  </div>
</div>

<!-- Gestion des noms -->
<div class="modal-back" id="peopleModal">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Ajout & modification des noms</h3>
    <div id="pmList" class="pm-list"></div>
    <div class="actions">
      <button id="pmAdd">Ajouter un nom</button>
      <button id="pmCancel">Annuler</button>
      <button id="pmSave" class="primary">Enregistrer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Enregistr√© ‚úÖ</div>

<script>
/* ====== Firebase init (TA config) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDzRKWYfnCiTQYogVQmYngfoCqGZlQxtJk",
  authDomain: "planning-secu.firebaseapp.com",
  databaseURL: "https://planning-secu-default-rtdb.europe-west1.firebasedatabase.app/", /* <-- slash final */
  projectId: "planning-secu",
  storageBucket: "planning-secu.firebasestorage.app",
  messagingSenderId: "688317228037",
  appId: "1:688317228037:web:eb57c7efdbfd081c96286c",
  measurementId: "G-H5XDZDJMH5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
/* Un chemin unique pour tout (tu peux le changer / le d√©couper par ann√©e) */
const CLOUD_PATH = "mbgardiennage/ieseg";

/* ===== S√âCURIT√â ===== */
const ADMIN_PASS="securite";
const PERSON_PASSES={Momo:"1",Lucas:"2",Sabri:"3",Sofiane:"4",Hamid:"5",Adam:"6",Iddir:"7",Karim:"8"};
let authRole=null,authUser=null,editUnlocked=false;

/* ===== √âTAT ===== */
let current="Sabri",currentYear=2025,currentMonth=7,editing=false,editDay=null;
let people=["Momo","Lucas","Sabri","Sofiane","Hamid","Adam","Iddir","Karim"];
const peopleData={}; // name->year->month->{days:{}}
const monthNames=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];

/* ===== HELPERS ===== */
function ensureMonth(name,y,m){if(!peopleData[name])peopleData[name]={};if(!peopleData[name][y])peopleData[name][y]={};if(!peopleData[name][y][m])peopleData[name][y][m]={days:{}};return peopleData[name][y][m];}
const colorOf=t=>({C:'var(--c)',P:'var(--p)',G:'var(--g)',R:'var(--r)'}[t]||'#999');
function weekNumber(dt){const t=new Date(Date.UTC(dt.getFullYear(),dt.getMonth(),dt.getDate()));const d=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-d);const y0=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil((((t-y0)/86400000)+1)/7);}
function mondayOf(dt){const d=(dt.getDay()+6)%7;const m=new Date(dt);m.setDate(dt.getDate()-d);return m;}
function parseTimeToHours(t){const m=t.match(/^(\d{1,2})h(?:(\d{2}))?$/i);if(!m)return null;const H=parseInt(m[1],10),M=parseInt(m[2]||"0",10);return H+(M/60);}
function computeHoursFromDetail(detail){const times=(detail.match(/\d{1,2}h\d{0,2}/g)||[]).map(parseTimeToHours).filter(v=>v!=null);let s=0;for(let i=0;i+1<times.length;i+=2)s+=times[i+1]-times[i];return Math.round(s*2)/2;}
function showToast(t){const el=document.getElementById('toast');el.textContent=t||"OK";el.style.display='block';setTimeout(()=>el.style.display='none',1500);}

/* ===== STOCKAGE local (fallback) ===== */
const STORAGE_KEY="planning_secure_v1";
function saveLocal(){const data={people,peopleData,current,currentYear,currentMonth};localStorage.setItem(STORAGE_KEY,JSON.stringify(data));}
function loadLocal(){try{const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||"null");if(!s)return false;people=s.people||people;Object.assign(peopleData,s.peopleData||{});current=s.current||current;currentYear=s.currentYear||currentYear;currentMonth=s.currentMonth||currentMonth;return true;}catch{return false;}}

/* ===== CLOUD (Firebase) ===== */
async function cloudSave() {
  const payload = { people, peopleData, current, currentYear, currentMonth, ts: Date.now() };
  try {
    await db.ref(CLOUD_PATH).set(payload);
    showToast("Sauvegard√© en ligne ‚òÅÔ∏è‚úÖ");
  } catch (err) {
    console.error("cloudSave error:", err);
    alert("Erreur sauvegarde cloud : " + (err?.message || err));
    throw err;
  }
}
async function cloudLoad() {
  try {
    const snap = await db.ref(CLOUD_PATH).get();
    if (!snap.exists()) return false;
    const s = snap.val();
    if (s.people) people = s.people;
    if (s.peopleData) { for (const k in peopleData) delete peopleData[k]; Object.assign(peopleData, s.peopleData); }
    current = s.current ?? current;
    currentYear = s.currentYear ?? currentYear;
    currentMonth = s.currentMonth ?? currentMonth;
    return true;
  } catch (err) {
    console.error("cloudLoad error:", err);
    alert("Erreur chargement cloud : " + (err?.message || err));
    return false;
  }
}

/* ===== SEED : Sabri ao√ªt (exemple), autres vides ===== */
function seedDefaultsIfEmpty(){
  const hasSabri=peopleData["Sabri"]&&peopleData["Sabri"][2025]&&peopleData["Sabri"][2025][7];
  if(!hasSabri){
    ensureMonth("Sabri",2025,7).days={
      1:{type:'C',hours:11,detail:'7h‚Äì12 / 13h30‚Äì21h30',note:'Fin 21h'},
      4:{type:'G',hours:8.5,detail:'7h30‚Äì12 / 13h30‚Äì21h'},
      6:{type:'R',hours:3.5,detail:'Ronde',note:'Fin 21h'},
      7:{type:'G',hours:8.5,detail:'7h30‚Äì12 / 13h30‚Äì21h'},
      8:{type:'G',hours:8.5,detail:'7h30‚Äì12 / 13h30‚Äì21h'},
      11:{type:'C',hours:11,detail:'7h‚Äì12 / 13h30‚Äì21h30',note:'Fin 19h'},
      12:{type:'C',hours:11,detail:'7h‚Äì12 / 13h30‚Äì21h30'},
      14:{type:'C',hours:11,detail:'7h‚Äì12 / 13h30‚Äì21h30',note:'Fin 19h'},
      19:{type:'P',hours:13,detail:'7h‚Äì13h30 / 15h‚Äì21h30'},
      20:{type:'C',hours:13,detail:'7h‚Äì12 / 13h30‚Äì21h30'},
      22:{type:'C',hours:13,detail:'7h‚Äì12 / 13h30‚Äì21h30'},
      26:{type:'C',hours:13,detail:'7h‚Äì12 / 13h30‚Äì21h30'},
      27:{type:'P',hours:13,detail:'7h‚Äì13h30 / 15h‚Äì21h30'},
      29:{type:'C',hours:13,detail:'7h‚Äì12 / 13h30‚Äì21h30'}
    };
  }
}

/* ===== ACCUEIL ===== */
const teamBtn=document.getElementById('teamBtn');
const teamSection=document.getElementById('teamSection');
teamBtn.onclick=()=>{teamSection.style.display='block';teamBtn.style.display='none';renderHome();};
document.getElementById('adminBtn').onclick=()=>{const p=prompt("Mot de passe administrateur :");if(p===ADMIN_PASS){authRole="admin";authUser=null;editUnlocked=true;enterApp("Sabri");showToast("Admin connect√© ‚úÖ");}else alert("Mot de passe incorrect.");};
document.getElementById('aboutBtn').onclick=()=>alert("Clique ¬´ √âquipe I√âSEG ¬ª, choisis un nom et entre son mot de passe. Admin = securite.");

function renderHome(){
  const grid=document.getElementById('homeGrid');grid.innerHTML='';
  ["Momo","Lucas","Sabri","Sofiane","Hamid","Adam","Iddir","Karim"].forEach(name=>{
    const card=document.createElement('div');card.className='person-card';
    card.innerHTML=`<div class="avatar"><span>${name[0]}</span></div><div class="pname">${name}</div><div class="pwd-hint">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</div>`;
    card.onclick=()=>requestAccess(name);grid.appendChild(card);
  });
}

function requestAccess(name){
  const pwd=prompt(`Mot de passe pour ${name} (ou "securite") :`); if(!pwd)return;
  if(pwd===ADMIN_PASS){authRole="admin";authUser=null;editUnlocked=true;enterApp(name);showToast("Admin connect√© ‚úÖ");}
  else if(PERSON_PASSES[name]===pwd){authRole="user";authUser=name;editUnlocked=false;enterApp(name);showToast(`Connect√© : ${name} ‚úÖ`);}
  else alert("Mot de passe incorrect.");
}

/* ===== Entrer / Quitter app ===== */
function enterApp(initialName){
  current=initialName||current;
  document.getElementById('home').style.display='none';
  document.getElementById('app').style.display='grid';
  document.getElementById('btnPeople').disabled=(authRole!=="admin");
  document.getElementById('btnEdit').disabled=(authRole!=="admin");
  renderSidebar(); render(); document.getElementById('now').textContent=new Date().toLocaleString('fr-FR');
}
function goHome(){editing=false;document.getElementById('app').style.display='none';document.getElementById('home').style.display='flex';}
document.getElementById('btnHome').onclick=goHome;
document.getElementById('btnLogout').onclick=()=>{authRole=null;authUser=null;editUnlocked=false;goHome();};

/* ===== Sidebar ===== */
const peopleEl=document.getElementById('people');
function renderSidebar(){
  peopleEl.innerHTML='';
  const visible=(authRole==="admin")?people:(authUser?[authUser]:[]);
  const colors=['#9bd0ff','#ffd28a','#8ec5ff','#c4f6c1','#ffb4b4','#d7c7ff','#ffe69b','#a0e9dd'];
  visible.forEach((name,i)=>{
    const el=document.createElement('div');el.className='person'+(name===current?' active':'');
    el.innerHTML=`<span class="badge" style="background:${colors[i%colors.length]}"></span>${name}`;
    el.onclick=()=>{current=name;document.querySelectorAll('.person').forEach(p=>p.classList.remove('active'));el.classList.add('active');saveLocal();render();closeMenu();};
    peopleEl.appendChild(el);
  });
  document.getElementById('lockInfo').textContent=editUnlocked?"‚úÖ Admin (√©dition autoris√©e)":"üëÅÔ∏è Lecture seule";
}

/* ===== Calendrier ===== */
function render(){
  document.getElementById('who').textContent=current;
  document.getElementById('monthLabel').textContent=`${monthNames[currentMonth]} ${currentYear}`;
  const store=ensureMonth(current,currentYear,currentMonth);const days=store.days;
  const cal=document.getElementById('cal');cal.innerHTML='';
  ['lun','mar','mer','jeu','ven','sam','dim'].forEach(d=>{const el=document.createElement('div');el.className='dow';el.textContent=d;cal.appendChild(el);});
  const first=new Date(currentYear,currentMonth,1),offset=(first.getDay()+6)%7,dim=new Date(currentYear,currentMonth+1,0).getDate();
  for(let i=0;i<offset;i++){const e=document.createElement('div');e.className='card empty';cal.appendChild(e);}
  for(let day=1;day<=dim;day++){
    const card=document.createElement('div');card.className='card';card.dataset.day=day;
    const dd=document.createElement('div');dd.className='date';dd.textContent=String(day).padStart(2,'0');card.appendChild(dd);
    const info=days[day];
    if(info){
      card.classList.add('work');
      const pill=document.createElement('div');pill.className='pill';pill.dataset.type=info.type;pill.style.background=colorOf(info.type);
      pill.innerHTML=`<span>${info.type}</span> <small>${String(info.hours).replace('.',',')} h</small>`;pill.title=info.detail||'';card.appendChild(pill);
      if(info.note){const n=document.createElement('div');n.className='note';n.textContent=info.note;card.appendChild(n);}
    }else if(editing&&editUnlocked){
      const plus=document.createElement('div');plus.className='pill';plus.style.background='#27406f';plus.textContent='+ Ajouter';plus.style.color='#fff';plus.style.marginTop='22px';card.appendChild(plus);
    }
    card.onclick=()=> (editing&&editUnlocked) && openEditor(day);
    cal.appendChild(card);
  }
  const filled=offset+dim,rest=(7-(filled%7))%7;for(let i=0;i<rest;i++){const e=document.createElement('div');e.className='card empty';cal.appendChild(e);}
  renderTotals(days);
}
function renderTotals(days){
  const totals=document.getElementById('totals');totals.innerHTML='';let monthSum=0;Object.values(days).forEach(v=>monthSum+=Number(v.hours||0));
  totals.appendChild(box('Total mois',`${monthSum.toFixed(2).replace('.',',')} h`));
  const weeks={},dim=new Date(currentYear,currentMonth+1,0).getDate();
  for(let d=1;d<=dim;d++){if(days[d]){const w=weekNumber(new Date(currentYear,currentMonth,d));weeks[w]=(weeks[w]||0)+Number(days[d].hours||0);}}
  Object.keys(weeks).sort((a,b)=>a-b).forEach(w=>totals.appendChild(box(`Sem. ${w}`,`${weeks[w].toFixed(2).replace('.',',')} h`)));
  function box(t,v){const el=document.createElement('div');el.className='box';el.innerHTML=`<h3>${t}</h3><div>${v}</div>`;return el;}
}

/* ===== Modale jour (admin) ===== */
const mb=document.getElementById('mb');const fType=document.getElementById('fType'),fHours=document.getElementById('fHours'),fDetail=document.getElementById('fDetail'),fNote=document.getElementById('fNote');
function openEditor(day){
  editDay=day;const d=ensureMonth(current,currentYear,currentMonth).days[day]||{type:'C',hours:'',detail:'',note:''};
  document.getElementById('mTitle').textContent=`${String(day).padStart(2,'0')}/${String(currentMonth+1).padStart(2,'0')}/${currentYear} ‚Äî ${current}`;
  fType.value=d.type||'C';fHours.value=(d.hours??'');fDetail.value=d.detail||'';fNote.value=d.note||'';mb.style.display='flex';
}
function closeEditor(){mb.style.display='none';editDay=null;}
document.getElementById('btnClose').onclick=closeEditor;
document.querySelectorAll('.chip[data-preset]').forEach(ch=>{ch.onclick=()=>{const p=JSON.parse(ch.dataset.preset);fType.value=p.type||'C';fDetail.value=p.detail||'';if(p.autoHours&&p.detail){const h=computeHoursFromDetail(p.detail);fHours.value=(isFinite(h)?h:0);}}});
document.getElementById('copyPrev').onclick=()=>{if(editDay==null)return;const prev=ensureMonth(current,currentYear,currentMonth).days[editDay-1];if(prev){fType.value=prev.type;fHours.value=prev.hours;fDetail.value=prev.detail||'';fNote.value=prev.note||'';}};
document.getElementById('btnSave').onclick=async()=>{if(!editUnlocked)return alert("√âdition admin requise.");if(editDay==null)return;
  ensureMonth(current,currentYear,currentMonth).days[editDay]={type:fType.value,hours:Number(fHours.value||0),detail:fDetail.value.trim(),note:fNote.value.trim()};
  saveLocal(); try{await cloudSave();}catch{}
  closeEditor();render();
};
document.getElementById('btnDel').onclick=async()=>{if(!editUnlocked)return alert("√âdition admin requise.");if(editDay==null)return;
  delete ensureMonth(current,currentYear,currentMonth).days[editDay];
  saveLocal(); try{await cloudSave();}catch{}
  closeEditor();render();
};
document.getElementById('btnWeek').onclick=async()=>{if(!editUnlocked)return alert("√âdition admin requise.");if(editDay==null)return;
  const dt=new Date(currentYear,currentMonth,editDay),mon=mondayOf(dt),dim=new Date(currentYear,currentMonth+1,0).getDate();
  const payload={type:fType.value,hours:Number(fHours.value||0),detail:fDetail.value.trim(),note:fNote.value.trim()};
  const store=ensureMonth(current,currentYear,currentMonth).days;for(let i=0;i<7;i++){const d=mon.getDate()+i;if(d>=1&&d<=dim){store[d]={...payload};}}
  saveLocal(); try{await cloudSave();}catch{}
  closeEditor();render();
};
document.getElementById('btnRange').onclick=async()=>{if(!editUnlocked)return alert("√âdition admin requise.");const ans=prompt("Appliquer du jour X au jour Y (ex: 5-12) :","");if(!ans)return;
  const m=ans.match(/^\s*(\d{1,2})\s*[-‚Äì]\s*(\d{1,2})\s*$/);if(!m)return alert("Format invalide. Exemple : 5-12");
  let a=parseInt(m[1],10),b=parseInt(m[2],10);if(a>b)[a,b]=[b,a];
  const dim=new Date(currentYear,currentMonth+1,0).getDate();a=Math.max(1,Math.min(dim,a));b=Math.max(1,Math.min(dim,b));
  const payload={type:fType.value,hours:Number(fHours.value||0),detail:fDetail.value.trim(),note:fNote.value.trim()};
  const store=ensureMonth(current,currentYear,currentMonth).days;for(let d=a;d<=b;d++){store[d]={...payload};}
  saveLocal(); try{await cloudSave();}catch{}
  closeEditor();render();
};

/* ===== Mois ===== */
const mpb=document.getElementById('mpb'),monthGrid=document.getElementById('monthGrid'),curYearEl=document.getElementById('curYear');
document.getElementById('monthLabel').onclick=()=>{curYearEl.textContent=currentYear;monthGrid.innerHTML='';monthNames.forEach((n,i)=>{const b=document.createElement('button');b.textContent=n[0].toUpperCase()+n.slice(1);b.onclick=()=>{currentMonth=i;mpb.style.display='none';saveLocal();cloudSave().catch(()=>{});render();};monthGrid.appendChild(b);});mpb.style.display='flex';};
document.getElementById('mpClose').onclick=()=>mpb.style.display='none';
mpb.addEventListener('click',e=>{if(e.target===mpb)mpb.style.display='none';});

/* ===== People manager (admin) ===== */
const pm=document.getElementById('peopleModal'),pmList=document.getElementById('pmList');
document.getElementById('btnPeople').onclick=()=>{if(authRole!=="admin")return alert("R√©serv√© √† l‚Äôadmin.");
  pmList.innerHTML='';people.forEach(name=>{const row=document.createElement('div');row.className='pm-row';
    const inp=document.createElement('input');inp.value=name;const del=document.createElement('button');del.textContent='Supprimer';del.className='danger';
    del.onclick=()=>{if(!confirm(`Supprimer "${name}" ?`))return;if(current===name){const next=people.find(n=>n!==name)||"Sabri";current=next;}delete peopleData[name];people=people.filter(n=>n!==name);row.remove();};
    row.appendChild(inp);row.appendChild(del);pmList.appendChild(row);
  });pm.style.display='flex';
};
document.getElementById('pmAdd').onclick=()=>{const row=document.createElement('div');row.className='pm-row';const inp=document.createElement('input');inp.placeholder='Nouveau nom';const del=document.createElement('button');del.textContent='Supprimer';del.className='danger';del.onclick=()=>row.remove();row.appendChild(inp);row.appendChild(del);pmList.appendChild(row);};
document.getElementById('pmCancel').onclick=()=>pm.style.display='none';
document.getElementById('pmSave').onclick=async()=>{const inputs=pmList.querySelectorAll('input');const list=[];inputs.forEach(i=>{const v=i.value.trim();if(v&&!list.includes(v))list.push(v);});if(!list.length)return alert("Il faut au moins un nom.");
  const newData={};list.forEach(n=>newData[n]=peopleData[n]||{});if(!list.includes(current))current=list[0];people=list;for(const k in peopleData)delete peopleData[k];Object.assign(peopleData,newData);
  pm.style.display='none';saveLocal(); try{await cloudSave();}catch{} renderSidebar();render();
};
pm.addEventListener('click',e=>{if(e.target===pm)pm.style.display='none';});

/* ===== Header actions ===== */
document.getElementById('btnPdf').onclick=()=>window.print();
document.getElementById('btnEdit').onclick=()=>{if(authRole!=="admin")return;editing=!editing;document.getElementById('btnEdit').textContent=editing?'Quitter l‚Äô√©dition':'Activer l‚Äô√©dition';if(!editing)document.getElementById('mb').style.display='none';render();};
document.getElementById('btnSaveAll').onclick=async()=>{saveLocal(); try{await cloudSave();}catch{showToast("Sauvegarde locale (offline) ‚úÖ");}};
document.getElementById('btnBackup').onclick=()=>{const blob=new Blob([localStorage.getItem(STORAGE_KEY)||"{}"],{type:"application/json"});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download="planning.json";a.click();URL.revokeObjectURL(a.href);};
document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=async e=>{const f=e.target.files[0];if(!f)return;const t=await f.text();localStorage.setItem(STORAGE_KEY,t);loadLocal();renderSidebar();render(); try{await cloudSave();}catch{} showToast("Planning import√© ‚òÅÔ∏è");};

/* ===== Drawer mobile ===== */
const sideEl=document.querySelector('.side');const overlayEl=document.getElementById('overlay');const menuBtn=document.getElementById('menuBtn');
function applyDrawerMode(){if(window.matchMedia('(max-width:880px)').matches){sideEl.classList.add('drawer');}else{sideEl.classList.remove('drawer','open');document.body.classList.remove('menu-open');overlayEl.style.display='none';}}
function openMenu(){if(!sideEl.classList.contains('drawer'))return;sideEl.classList.add('open');document.body.classList.add('menu-open');overlayEl.style.display='block';}
function closeMenu(){sideEl.classList.remove('open');document.body.classList.remove('menu-open');overlayEl.style.display='none';}
menuBtn.addEventListener('click',openMenu);overlayEl.addEventListener('click',closeMenu);window.addEventListener('resize',applyDrawerMode);applyDrawerMode();

/* ===== BOOT (CLOUD FIRST) ===== */
(async ()=>{
  // 1) Cloud d'abord
  let loadedCloud = false;
  try { loadedCloud = await cloudLoad(); } catch { loadedCloud = false; }

  // 2) Fallback local si cloud vide/erreur
  if (!loadedCloud) {
    const hadLocal = loadLocal();
    if (!hadLocal) seedDefaultsIfEmpty();
  }

  // 3) Affichage accueil
  document.getElementById('now').textContent=new Date().toLocaleString('fr-FR');
  document.getElementById('home').style.display='flex';
  document.getElementById('app').style.display='none';
})();
</script>

<!-- Overlay pour tiroir mobile -->
<div id="overlay"></div>
</body>

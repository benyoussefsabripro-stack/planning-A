<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MB Gardiennage ‚Äî Planning s√©curis√©</title>

<!-- Firebase SDK (compat pour simplicit√©) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#0b1220; --text:#e5e7eb; --muted:#9aa3b2;
    --card:#0f172a; --border:#1f2a44; --shadow:0 10px 30px rgba(0,0,0,.35);
    --c:#1e88ff; --p:#08a86b; --g:#ff8a2a; --r:#8b5cf6;
    --accent:#2b5cff; --danger:#ef4444;
    --sidebar:#0f172a; --sidebar-border:#1f2a44; --sidebar-hover:#162746;
    --chip:#101b33; --chip-bd:#2c3b63;
    --grad: radial-gradient(1200px 600px at 0% 0%, #102041, #0b1220 60%);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}

  /* ===== Accueil ===== */
  #home{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--grad);padding:24px}
  .home-card{width:100%;max-width:860px;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:22px}
  .home-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .home-title{font-weight:900;font-size:20px;color:#cfe0ff}
  .home-sub{color:var(--muted);margin:6px 0 14px}
  .btn{background:#13213d;border:1px solid #2a3d6d;color:#e5e7eb;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
  .btn:hover{background:#142a57}
  .team-tile{margin:6px 0 14px;background:#0e1b33;border:1px solid #253a6b;padding:16px;border-radius:16px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;box-shadow:var(--shadow)}
  .team-tile:hover{background:#11244a}
  .home-grid{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
  @media(min-width:720px){.home-grid{grid-template-columns:repeat(4,1fr)}}
  .person-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;transition:transform .12s}
  .person-card:hover{transform:translateY(-1px);background:var(--sidebar-hover)}
  .avatar{width:64px;height:64px;border-radius:50%;border:2px solid var(--border);background:#17345f;display:flex;align-items:center;justify-content:center;font-weight:900}

  /* ===== App ===== */
  .app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
  .side{background:var(--sidebar);border-right:1px solid var(--sidebar-border);padding:16px 12px}
  .logo{font-weight:900;font-size:18px;color:#cfe0ff;margin-bottom:12px}
  .people{display:flex;flex-direction:column;gap:6px}
  .person{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .person:hover{background:var(--sidebar-hover)}
  .person.active{outline:2px solid #2b5cff66}
  .badge{width:10px;height:10px;border-radius:50%}
  .lock{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}

  header{position:sticky;top:0;background:var(--bg);z-index:15;display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 12px 10px;border-bottom:1px solid #1b2340}
  h1{margin:0;font-size:20px}
  #monthLabel{cursor:pointer;border-bottom:2px dashed transparent}
  #monthLabel:hover{border-color:#2b5cff}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  button{background:#13213d;border:1px solid #2a3d6d;color:#e5e7eb;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
  button:hover{background:#142a57}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.danger{border-color:#7f1d1d;background:#3f1d1d;color:#fecaca}
  button[disabled]{opacity:.6;cursor:not-allowed}
  #menuBtn{display:none;border-radius:10px;padding:8px 10px}

  .wrap{max-width:1140px;margin:0 auto 40px;padding:0 12px}
  .legend{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0 12px}
  .tag{display:inline-flex;gap:8px;align-items:center;font-size:13px;color:#94a3b8}
  .sw{width:14px;height:14px;border-radius:4px;display:inline-block}
  .totals{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .box{background:#0f172a;border:1px solid #1f2a44;border-radius:12px;padding:10px 14px;box-shadow:var(--shadow)}
  .box h3{margin:0 0 4px;font-size:11px;color:#9aa3b2;letter-spacing:.08em}
  .box div{font-size:18px;font-weight:900}

  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .dow{font-size:12px;color:#9aa3b2;text-transform:uppercase;letter-spacing:.06em;text-align:center}
  .card{background:linear-gradient(180deg,#0f172a,#0c1426);border:1px solid #202b48;border-radius:16px;padding:10px;min-height:112px;position:relative;box-shadow:var(--shadow);transition:transform .08s ease}
  .card:hover{transform:translateY(-1px)}
  .date{position:absolute;top:8px;left:10px;font-weight:900;font-size:13px;color:#94a3b8}
  .pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;padding:7px 11px;border-radius:999px;font-weight:900;margin-top:22px;width:max-content;color:#fff;border:none}
  .pill[data-type="C"]{background:var(--c)} .pill[data-type="P"]{background:var(--p)}
  .pill[data-type="G"]{background:var(--g)} .pill[data-type="R"]{background:var(--r)}
  .note{font-size:12px;color:#a78bfa;margin-top:6px}
  .mates{font-size:12px;color:#94a3b8;margin-top:6px}
  .empty{opacity:.25}
  footer{color:#9aa3b2;text-align:center;padding:14px}
  .small{font-size:11px}

  /* Modals */
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{background:var(--chip);border:1px solid var(--chip-bd);border-radius:999px;padding:7px 10px;font-weight:800;cursor:pointer}
  .chip:hover{background:#182a55}
  .modal-back{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:30}
  .modal{background:#0f172a;max-width:620px;width:100%;border-radius:16px;padding:14px;border:1px solid #1f2a44;box-shadow:0 22px 48px rgba(0,0,0,.5)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:#cbd5e1;font-weight:700}
  input,select{width:100%;padding:10px;border:1px solid #2a3d6d;border-radius:10px;font-size:14px;background:#091124;color:#e5e7eb}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}

  /* Drawer mobile */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:25}
  .side.drawer{position:fixed;top:0;left:0;height:100vh;width:86vw;max-width:320px;transform:translateX(-100%);transition:transform .25s ease;z-index:30;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .side.drawer.open{transform:translateX(0)}
  body.menu-open{overflow:hidden}

  /* Mobile */
  @media (max-width:880px){
    .app{grid-template-columns:1fr}
    .side{position:static}
    .side.drawer{display:block}
    #menuBtn{display:inline-block}
    .wrap{padding:0 10px}
    .calendar{grid-template-columns:repeat(2,1fr);gap:8px}
    .card{min-height:108px;padding:10px}
    .pill{padding:8px 12px;font-size:14px}
    h1{font-size:18px}
  }
  @media (max-width:390px){
    .calendar{gap:6px}
    .card{min-height:100px}
    .pill{font-size:13px}
  }

  .toast{position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none;z-index:50}
  @media print{
    #home,.side,header .toolbar,#menuBtn,#overlay,.modal-back,.small,.toast{display:none}
    .card{break-inside:avoid}
    .card.work .date{font-weight:900}
    .card.work .pill{font-weight:900}
    body{background:#fff}
  }
</style>
</head>
<body>

<!-- ===== ACCUEIL ===== -->
<section id="home">
  <div class="home-card">
    <div class="home-header">
      <div>
        <div class="home-title">MB Gardiennage ‚Äî Planning</div>
        <div class="home-sub">Bienvenue sur l‚Äôespace de consultation des plannings de l‚Äôentreprise <b>MB Gardiennage</b>.</div>
      </div>
      <div>
        <button class="btn" id="adminBtn">Admin</button>
        <button class="btn" id="aboutBtn" title="Infos">‚ÑπÔ∏è</button>
      </div>
    </div>

    <div id="teamBtn" class="team-tile">
      <span class="team-title">√âquipe I√âSEG</span>
      <span class="team-chip">Afficher les noms ‚ñ∂</span>
    </div>

    <div id="teamSection" style="display:none">
      <div class="home-grid" id="homeGrid"></div>
    </div>

    <p style="margin-top:10px;color:#9aa3b2;font-size:12px">Mots de passe : Momo=<b>1</b>, Lucas=<b>2</b>, Sabri=<b>3</b>, Sofiane=<b>4</b>, Hamid=<b>5</b>, Adama=<b>6</b>, Iddir=<b>7</b>, Karim=<b>8</b>. Admin global = <b>securite</b>.</p>
  </div>
</section>

<!-- ===== APPLICATION ===== -->
<div id="app" class="app" style="display:none">
  <aside class="side">
    <div class="logo">üóìÔ∏è Planning</div>
    <div class="people" id="people"></div>
    <div class="lock" id="lockInfo">üîí Lecture seule</div>
    <div style="margin-top:14px;color:#9aa3b2;font-size:12px">Astuce : clique le <b>mois</b> pour changer.</div>
  </aside>

  <main>
    <header>
      <button id="menuBtn" aria-label="Ouvrir le menu">‚ò∞</button>
      <h1><span id="monthLabel">ao√ªt 2025</span> ‚Äî <span id="who" style="color:#9aa3b2">Sabri</span></h1>
      <div class="toolbar">
        <button id="btnHome">Accueil</button>
        <button id="btnLogout" class="danger">D√©connexion</button>
        <button id="btnPdf">PDF</button>
        <button id="btnEdit" disabled>Activer l‚Äô√©dition</button>
        <button id="btnPeople" disabled>Ajout & modification</button>
        <button id="btnSaveAll">Enregistrer</button>
      </div>
    </header>

    <div class="wrap">
      <div class="legend">
        <span class="tag"><span class="sw" style="background:var(--c)"></span> C</span>
        <span class="tag"><span class="sw" style="background:var(--p)"></span> P</span>
        <span class="tag"><span class="sw" style="background:var(--g)"></span> G</span>
        <span class="tag"><span class="sw" style="background:var(--r)"></span> R (Ronde/Fin sp√©ciale)</span>
      </div>
      <div id="totals" class="totals"></div>
      <div id="cal" class="calendar" aria-live="polite"></div>
      <p class="small">Derni√®re mise √† jour : <span id="now"></span></p>
    </div>
    <footer>Jours travaill√©s en <b>gras</b> sur le PDF. Admin : <b>securite</b>.</footer>
  </main>
</div>

<!-- ===== MODALE JOUR ===== -->
<div class="modal-back" id="mb">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <h2 id="mTitle">Modifier</h2>
    <div class="chips">
      <span class="chip" data-preset='{"type":"P","detail":"Promenade 7h/13h30 - 15h/21h30","autoHours":true}'>Promenade 7h/13h30 - 15h/21h30</span>
      <span class="chip" data-preset='{"type":"P","detail":"Promenade 9h/15h - 16h30/21h30","autoHours":true}'>Promenade 9h/15h - 16h30/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h/12h - 13h30/21h30","autoHours":true}'>Colline 7h/12h - 13h30/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 9h/13h30 - 15h/21h30","autoHours":true}'>Colline 9h/13h30 - 15h/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h30/12h - 13h/19h30","autoHours":true}'>Colline 7h30/12h - 13h/19h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h30/13h - 14h/21h30","autoHours":true}'>Colline 7h30/13h - 14h/21h30</span>
      <span class="chip" data-preset='{"type":"G","detail":"Grande Arche 7h30/12h - 13h30/21h","autoHours":true}'>Grande Arche 7h30/12h - 13h30/21h</span>
      <span class="chip" id="copyPrev">Copier la veille</span>
    </div>
    <div class="row">
      <div>
        <label>Type</label>
        <select id="fType">
          <option value="C">C</option>
          <option value="P">P</option>
          <option value="G">G</option>
          <option value="R">R (Ronde/Fin sp√©ciale)</option>
        </select>
      </div>
      <div>
        <label>Heures</label>
        <input id="fHours" type="number" step="0.5" min="0" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>D√©tail</label>
        <input id="fDetail" placeholder="Ex: Promenade 7h‚Äì12 / 13h30‚Äì21h30" />
      </div>
      <div>
        <label>Note</label>
        <input id="fNote" placeholder="Fin 19h" />
      </div>
    </div>
    <div class="actions">
      <button id="btnWeek">Remplir la semaine</button>
      <button id="btnRange">Appliquer sur une plage</button>
      <button id="btnDel" class="danger">Supprimer</button>
      <button id="btnClose">Fermer</button>
      <button id="btnSave" class="primary">Enregistrer</button>
    </div>
  </div>
</div>

<!-- S√©lecteur de mois -->
<div class="modal-back" id="mpb">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Choisir un mois ‚Äî <span id="curYear"></span></h3>
    <div id="monthGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px"></div>
    <div class="actions"><button id="mpClose">Fermer</button></div>
  </div>
</div>

<!-- Gestion des noms -->
<div class="modal-back" id="peopleModal">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Ajout & modification des noms</h3>
    <div id="pmList" class="pm-list"></div>
    <div class="actions">
      <button id="pmAdd">Ajouter un nom</button>
      <button id="pmCancel">Annuler</button>
      <button id="pmSave" class="primary">Enregistrer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Enregistr√© ‚úÖ</div>

<script>
/* ====== Firebase init (TA config corrig√©e) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDzRKWYfnCiTQYogVQmYngfoCqGZlQxtJk",
  authDomain: "planning-secu.firebaseapp.com",
  databaseURL: "https://planning-secu-default-rtdb.europe-west1.firebasedatabase.app/", /* slash final */
  projectId: "planning-secu",
  storageBucket: "planning-secu.appspot.com", /* corrig√© */
  messagingSenderId: "688317228037",
  appId: "1:688317228037:web:eb57c7efdbfd081c96286c",
  measurementId: "G-H5XDZDJMH5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const CLOUD_PATH = "mbgardiennage/ieseg";

/* ===== R√îLES & ACC√àS ===== */
const ADMIN_PASS="securite";
const PERSON_PASSES={Momo:"1",Lucas:"2",Sabri:"3",Sofiane:"4",Hamid:"5",Adama:"6",Iddir:"7",Karim:"8"};
let authRole=null,authUser=null;
let canEditAll=false, canViewAll=false; // Momo & Admin: edit+view all ; Sabri: view all (read-only)

/* ===== √âTAT ===== */
let current="Sabri",currentYear=2025,currentMonth=7,editing=false,editDay=null;
let people=["Momo","Lucas","Sabri","Sofiane","Hamid","Adama","Iddir","Karim"];
const peopleData={}; // name->year->month->{days:{}}
const monthNames=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];

/* ===== HELPERS ===== */
function ensureMonth(name,y,m){if(!peopleData[name])peopleData[name]={};if(!peopleData[name][y])peopleData[name][y]={};if(!peopleData[name][y][m])peopleData[name][y][m]={days:{}};return peopleData[name][y][m];}
const colorOf=t=>({C:'var(--c)',P:'var(--p)',G:'var(--g)',R:'var(--r)'}[t]||'#999');
function weekNumber(dt){const t=new Date(Date.UTC(dt.getFullYear(),dt.getMonth(),dt.getDate()));const d=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-d);const y0=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil((((t-y0)/86400000)+1)/7);}
function mondayOf

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Planning ‚Äî Mobile + S√©curit√©</title>
<style>
  :root{
    --bg:#f6f8ff; --text:#121625; --muted:#6b7280;
    --card:#ffffff; --border:#e5e7eb; --shadow:0 10px 30px rgba(15,23,42,.08);
    --c:#1e88ff; --p:#08a86b; --g:#ff8a2a; --r:#8b5cf6;
    --brand:#2b5cff; --accent:#2b5cff; --danger:#ef4444;
    --sidebar:#ffffff; --sidebar-border:#e5e7eb; --sidebar-hover:#eef2ff;
    --chip:#eef2ff; --chip-bd:#c7d2fe;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .app{display:grid;grid-template-columns:270px 1fr;min-height:100vh}

  /* Sidebar / menu */
  .side{background:var(--sidebar);border-right:1px solid var(--sidebar-border);padding:16px 12px}
  .logo{font-weight:900;font-size:18px;letter-spacing:.2px;color:var(--brand);margin-bottom:12px}
  .people{display:flex;flex-direction:column;gap:6px}
  .person{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .person:hover{background:var(--sidebar-hover)}
  .person.active{background:#e6ecff;outline:2px solid #c9d2ff}
  .badge{width:10px;height:10px;border-radius:50%}
  .lock{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}

  /* Header + toolbar */
  header{
    position:sticky; top:0; background:var(--bg); z-index:15;
    display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 12px 10px
  }
  h1{margin:0;font-size:20px}
  #monthLabel{cursor:pointer;border-bottom:2px dashed transparent}
  #monthLabel:hover{border-color:#c7d2fe}
  .muted{color:var(--muted)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  button{background:#fff;border:1px solid #d1d5db;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)}
  button:hover{background:#f9fbff}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  button.danger{border-color:#fecaca;background:#fff1f2;color:#b91c1c}
  button[disabled]{opacity:.6;cursor:not-allowed}
  #menuBtn{display:none;border:1px solid #d1d5db;border-radius:10px;font-weight:900;background:#fff;box-shadow:var(--shadow);padding:8px 10px}

  .wrap{max-width:1100px;margin:0 auto 40px;padding:0 12px}
  .legend{display:flex;gap:12px;flex-wrap:wrap;margin:4px 0 12px}
  .tag{display:inline-flex;gap:8px;align-items:center;font-size:13px;color:#374151}
  .sw{width:14px;height:14px;border-radius:4px;display:inline-block}
  .totals{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px}
  .box{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 14px;box-shadow:var(--shadow)}
  .box h3{margin:0 0 4px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
  .box div{font-size:18px;font-weight:900}

  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .dow{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;text-align:center}
  .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:10px;min-height:96px;position:relative;box-shadow:var(--shadow);cursor:pointer}
  .date{position:absolute;top:8px;left:10px;font-weight:900;font-size:13px;color:#434a5e}
  .pill{display:inline-flex;align-items:center;gap:6px;font-size:13px;padding:6px 10px;border-radius:999px;font-weight:900;margin-top:22px;width:max-content;color:#fff;border:none}
  .pill[data-type="C"]{background:var(--c)} .pill[data-type="P"]{background:var(--p)}
  .pill[data-type="G"]{background:var(--g)} .pill[data-type="R"]{background:var(--r)}
  .note{font-size:12px;color:#6d28d9;margin-top:6px}
  .empty{opacity:.35}
  footer{color:var(--muted);text-align:center;padding:18px}
  .small{font-size:11px}

  /* Chips + modals */
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{background:var(--chip);border:1px solid var(--chip-bd);border-radius:999px;padding:7px 10px;font-weight:800;cursor:pointer}
  .chip:hover{background:#e0e7ff}
  .modal-back{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:30}
  .modal{background:#fff;max-width:620px;width:100%;border-radius:16px;padding:14px;border:1px solid #e5e7eb;box-shadow:0 22px 48px rgba(15,23,42,.22)}
  .modal h2,.modal h3{margin:0 0 8px;font-size:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-size:12px;color:#374151;font-weight:700}
  input,select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
  .pm-list{display:flex;flex-direction:column;gap:8px;margin:10px 0}
  .pm-row{display:flex;gap:8px}
  .pm-row input{flex:1}

  /* Overlay + tiroir mobile */
  #overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:25}
  .side.drawer{
    position:fixed; top:0; left:0; height:100vh; width:86vw; max-width:320px;
    transform:translateX(-100%); transition:transform .25s ease;
    z-index:30; box-shadow:0 20px 60px rgba(0,0,0,.25)
  }
  .side.drawer.open{ transform:translateX(0) }
  body.menu-open{ overflow:hidden }

  /* Mobile */
  @media (max-width:880px){
    .app{ grid-template-columns:1fr }
    .side{ position:static }
    .side.drawer{ display:block }
    #menuBtn{ display:inline-block }

    .wrap{ padding:0 10px }
    .calendar{ grid-template-columns:repeat(2,1fr); gap:8px }
    .card{ min-height:88px; padding:10px }
    .pill{ padding:8px 12px; font-size:14px }
    .chips .chip{ padding:9px 12px; font-size:14px }
    .legend{ margin-top:6px }
    h1{ font-size:18px }
  }
  @media (max-width:390px){
    .calendar{ gap:6px }
    .card{ min-height:84px }
    .pill{ font-size:13px }
  }

  /* Toast */
  .toast{position:fixed;right:18px;bottom:18px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none;z-index:50}

  /* Impression / PDF */
  @media print{
    .side, header .toolbar, #menuBtn, #overlay, .modal-back, .small, .toast, #peopleModal, #statsModal{display:none}
    .card{break-inside:avoid}
    .card.work .date{font-weight:900}
    .card.work .pill{font-weight:900}
    body{background:white}
  }
</style>

<!-- (Optionnel) Firebase pour sync en ligne si tu configures plus bas -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<!-- Overlay pour le tiroir mobile -->
<div id="overlay"></div>

<div class="app">
  <!-- Sidebar -->
  <aside class="side">
    <div class="logo">üóìÔ∏è Planning</div>
    <div class="people" id="people"></div>
    <div class="lock" id="lockInfo">üîí √âdition verrouill√©e</div>
    <div style="margin-top:14px;color:var(--muted);font-size:12px">Astuce : clique le <b>mois</b> pour changer.</div>
  </aside>

  <!-- Main -->
  <main>
    <header>
      <button id="menuBtn" aria-label="Ouvrir le menu">‚ò∞</button>
      <h1><span id="monthLabel">ao√ªt 2025</span> ‚Äî <span class="muted" id="who">Sabri</span></h1>
      <div class="toolbar">
        <button id="btnPdf">Exporter PDF</button>
        <button id="btnUnlock" class="primary">D√©verrouiller (mot de passe)</button>
        <button id="btnEdit" disabled>Activer l‚Äô√©dition</button>
        <button id="btnPeople" disabled>Ajout & modification</button>
        <button id="btnSaveAll">Enregistrer les modifications</button>
        <button id="btnStats">Stats annuelles</button>
        <button id="btnSync" title="Synchroniser via Firebase (optionnel)">Synchroniser</button>
        <button id="btnBackup">Exporter JSON</button>
        <button id="btnImport">Importer JSON</button>
        <input type="file" id="fileImport" accept="application/json" hidden>
      </div>
    </header>

    <div class="wrap">
      <div class="legend">
        <span class="tag"><span class="sw" style="background:var(--c)"></span> C</span>
        <span class="tag"><span class="sw" style="background:var(--p)"></span> P</span>
        <span class="tag"><span class="sw" style="background:var(--g)"></span> G</span>
        <span class="tag"><span class="sw" style="background:var(--r)"></span> Fin sp√©ciale / Ronde</span>
      </div>

      <div id="totals" class="totals"></div>
      <div id="cal" class="calendar" aria-live="polite"></div>
      <p class="small">Derni√®re mise √† jour : <span id="now"></span></p>
    </div>
    <footer>Mobile pr√™t : menu ‚ò∞, deux colonnes lisibles. Jours travaill√©s en <b>gras</b> au PDF. Mot de passe : <b>securite</b>.</footer>
  </main>
</div>

<!-- MODAL √âDITION JOUR -->
<div class="modal-back" id="mb">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <h2 id="mTitle">Modifier</h2>
    <div class="chips">
      <span class="chip" data-preset='{"type":"P","detail":"Promenade 7h/13h30 - 15h/21h30","autoHours":true}'>Promenade 7h/13h30 - 15h/21h30</span>
      <span class="chip" data-preset='{"type":"P","detail":"Promenade 9h/15h - 16h30/21h30","autoHours":true}'>Promenade 9h/15h - 16h30/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h/12h - 13h30/21h30","autoHours":true}'>Colline 7h/12h - 13h30/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 9h/13h30 - 15h/21h30","autoHours":true}'>Colline 9h/13h30 - 15h/21h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h30/12h - 13h/19h30","autoHours":true}'>Colline 7h30/12h - 13h/19h30</span>
      <span class="chip" data-preset='{"type":"C","detail":"Colline 7h30/13h - 14h/21h30","autoHours":true}'>Colline 7h30/13h - 14h/21h30</span>
      <span class="chip" data-preset='{"type":"G","detail":"Grande Arche 7h30/12h - 13h30/21h","autoHours":true}'>Grande Arche 7h30/12h - 13h30/21h</span>
      <span class="chip" id="copyPrev">Copier la veille</span>
    </div>
    <div class="row">
      <div>
        <label>Type</label>
        <select id="fType">
          <option value="C">C</option>
          <option value="P">P</option>
          <option value="G">G</option>
          <option value="R">R (Ronde/Fin sp√©ciale)</option>
        </select>
      </div>
      <div>
        <label>Heures</label>
        <input id="fHours" type="number" step="0.5" min="0" />
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>D√©tail</label>
        <input id="fDetail" placeholder="7h‚Äì12 / 13h30‚Äì21h30" />
      </div>
      <div>
        <label>Note</label>
        <input id="fNote" placeholder="Fin 19h" />
      </div>
    </div>
    <div class="actions">
      <button id="btnWeek">Remplir la semaine</button>
      <button id="btnRange">Appliquer sur une plage</button>
      <button id="btnDel" class="danger">Supprimer</button>
      <button id="btnClose">Fermer</button>
      <button id="btnSave" class="primary">Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL S√âLECTEUR DE MOIS -->
<div class="modal-back" id="mpb">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Choisir un mois ‚Äî <span id="curYear"></span></h3>
    <div class="mp-grid" id="monthGrid"></div>
    <div class="actions"><button id="mpClose">Fermer</button></div>
  </div>
</div>

<!-- MODAL GESTION DES NOMS -->
<div class="modal-back" id="peopleModal">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Ajout & modification des noms</h3>
    <div id="pmList" class="pm-list"></div>
    <div class="actions">
      <button id="pmAdd">Ajouter un nom</button>
      <button id="pmCancel">Annuler</button>
      <button id="pmSave" class="primary">Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL STATS -->
<div class="modal-back" id="statsModal">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Stats annuelles <span id="statsYear"></span></h3>
    <div id="statsBody" style="max-height:60vh;overflow:auto"></div>
    <div class="actions"><button id="statsClose">Fermer</button></div>
  </div>
</div>

<div class="toast" id="toast">Enregistr√© ‚úÖ</div>

<script>
/* ====== CONFIG SYNC (Optionnel) ====== */
const ENABLE_SYNC = false;
const firebaseConfig = {
  // apiKey: "xxx",
  // authDomain: "xxx.firebaseapp.com",
  // databaseURL: "https://xxx-default-rtdb.europe-west1.firebasedatabase.app",
  // projectId: "xxx",
  // storageBucket: "xxx.appspot.com",
  // messagingSenderId: "xxx",
  // appId: "xxx"
};
let appFB=null, dbFB=null;
try{ if(ENABLE_SYNC && firebaseConfig.apiKey){ appFB=firebase.initializeApp(firebaseConfig); dbFB=firebase.database(); } }catch(e){}

/* ====== S√©curit√© ====== */
const EDIT_PASSWORD = "securite";
let editUnlocked = false;

/* ====== Stockage ====== */
const STORAGE_KEY = "planning_mobile_secure_v1";

/* ====== √âtat ====== */
const monthNames = ["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
let currentYear = 2025;
let currentMonth = 7;
let current = "Sabri";
let editing = false;
let editDay = null;

let people = ["Momo","Lucas","Sabri","Sofiane","Hamid","Adam","Iddir","Karim"];
const peopleData = {}; // peopleData[name][year][month] = {days:{}}

/* Helpers */
function ensureMonth(name, year, month){
  if(!peopleData[name]) peopleData[name]={};
  if(!peopleData[name][year]) peopleData[name][year]={};
  if(!peopleData[name][year][month]) peopleData[name][year][month]={days:{}};
  return peopleData[name][year][month];
}
const colorOf=t=>({C:'var(--c)',P:'var(--p)',G:'var(--g)',R:'var(--r)'}[t]||'#999');
function weekNumber(dt){const t=new Date(Date.UTC(dt.getFullYear(),dt.getMonth(),dt.getDate()));const d=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-d);const y0=new Date(Date.UTC(t.getUTCFullYear(),0,1));return Math.ceil((((t-y0)/86400000)+1)/7);}
function mondayOf(dt){const d=(dt.getDay()+6)%7;const m=new Date(dt);m.setDate(dt.getDate()-d);return m;}
function parseTimeToHours(t){const m=t.match(/^(\d{1,2})h(?:(\d{2}))?$/i);if(!m)return null;const H=parseInt(m[1],10),M=parseInt(m[2]||"0",10);return H+(M/60);}
function computeHoursFromDetail(detail){const times=(detail.match(/\d{1,2}h\d{0,2}/g)||[]).map(parseTimeToHours).filter(v=>v!=null);let sum=0;for(let i=0;i+1<times.length;i+=2){sum+=(times[i+1]-times[i]);}return Math.round(sum*2)/2;}
function showToast(txt){const t=document.getElementById('toast');t.textContent=txt||"OK";t.style.display='block';setTimeout(()=>t.style.display='none',1500);}

/* Sauvegarde */
function saveState(silent=false){const data={people,peopleData,currentYear,currentMonth,current};localStorage.setItem(STORAGE_KEY,JSON.stringify(data));if(!silent)showToast("Enregistr√© ‚úÖ");}
function loadState(){try{const raw=localStorage.getItem(STORAGE_KEY);if(!raw)return false;const s=JSON.parse(raw);if(Array.isArray(s.people))people=s.people;if(s.peopleData)Object.assign(peopleData,s.peopleData);if(typeof s.currentYear==="number")currentYear=s.currentYear;if(typeof s.currentMonth==="number")currentMonth=s.currentMonth;if(s.current)current=s.current;return true;}catch(e){return false;}}

/* Defaults si vide */
function seedDefaultsIfEmpty(){
  if(!peopleData["Sabri"]||!peopleData["Sabri"][2025]||!peopleData["Sabri"][2025][7]){
    ensureMonth("Sabri",2025,7).days={
      1:{type:'C',hours:11,detail:'7h‚Äì12 / 13h30‚Äì21h30',note:'Fin 21h'},
      4:{type:'G',hours:8.5,detail:'7h30‚Äì12 / 13h30‚Äì21h'},
      6:{type:'R',hours:3.5,detail:'Ronde',note:'Fin 21h'},
      7:{type:'G',hours:8.5,detail:'7h30‚Äì12 / 13h30‚Äì21h'},
      8:{type:'G',hours:8.5,detail:'7h30‚Äì12 / 13h30‚Äì21h'},
      11:{type:'C',hours:11,detail:'7h‚Äì12 / 13h30‚Äì21h30',note:'Fin 19h'},
      12:{type:'C',hours:11,detail:'7h‚Äì12 / 13h30‚Äì21h30'},
      14:{type:'C',hours:11,detail:'7h‚Äì12 / 13h30‚Äì21h30',note:'Fin 19h'},
      19:{type:'P',hours:13,detail:'7h‚Äì13h30 / 15h‚Äì21h30'},
      20:{type:'C',hours:13,detail:'7h‚Äì12 / 13h30‚Äì21h30'},
      22:{type:'C',hours:13,detail:'7h‚Äì12 / 13h30‚Äì21h30'},
      26:{type:'C',hours:13,detail:'7h‚Äì12 / 13h30‚Äì21h30'},
      27:{type:'P',hours:13,detail:'7h‚Äì13h30 / 15h‚Äì21h30'},
      29:{type:'C',hours:13,detail:'7h‚Äì12 / 13h30‚Äì21h30'}
    };
  }
}

/* Sidebar */
const peopleEl=document.getElementById('people');
function renderSidebar(){
  peopleEl.innerHTML='';
  const colors=['#9bd0ff','#ffd28a','#8ec5ff','#c4f6c1','#ffb4b4','#d7c7ff','#ffe69b','#a0e9dd'];
  people.forEach((name,i)=>{
    const el=document.createElement('div');
    el.className='person'+(name===current?' active':'');
    el.dataset.name=name;
    el.innerHTML=`<span class="badge" style="background:${colors[i%colors.length]}"></span>${name}`;
    el.onclick=()=>{current=name;document.querySelectorAll('.person').forEach(p=>p.classList.remove('active'));el.classList.add('active');saveState(true);render();closeMenu();};
    peopleEl.appendChild(el);
  });
  document.getElementById('lockInfo').textContent=editUnlocked?"‚úÖ √âdition d√©verrouill√©e":"üîí √âdition verrouill√©e";
}

/* Calendrier */
function render(){
  document.getElementById('who').textContent=current;
  document.getElementById('monthLabel').textContent=`${monthNames[currentMonth]} ${currentYear}`;
  const store=ensureMonth(current,currentYear,currentMonth);
  const days=store.days;

  const cal=document.getElementById('cal'); cal.innerHTML='';
  ['lun','mar','mer','jeu','ven','sam','dim'].forEach(d=>{const el=document.createElement('div');el.className='dow';el.textContent=d;cal.appendChild(el);});
  const first=new Date(currentYear,currentMonth,1),offset=(first.getDay()+6)%7,dim=new Date(currentYear,currentMonth+1,0).getDate();
  for(let i=0;i<offset;i++){const e=document.createElement('div');e.className='card empty';cal.appendChild(e);}
  for(let day=1;day<=dim;day++){
    const card=document.createElement('div');card.className='card';card.dataset.day=day;
    const dd=document.createElement('div');dd.className='date';dd.textContent=String(day).padStart(2,'0');card.appendChild(dd);
    const info=days[day];
    if(info){
      card.classList.add('work');
      const pill=document.createElement('div');pill.className='pill';pill.dataset.type=info.type;pill.style.background=colorOf(info.type);
      pill.innerHTML=`<span>${info.type}</span> <small>${String(info.hours).replace('.',',')} h</small>`;pill.title=info.detail||'';card.appendChild(pill);
      if(info.note){const n=document.createElement('div');n.className='note';n.textContent=info.note;card.appendChild(n);}
    }else if(editing){
      const plus=document.createElement('div');plus.className='pill';plus.style.background='#9aa5b1';plus.textContent='+ Ajouter';plus.style.color='#fff';plus.style.marginTop='22px';card.appendChild(plus);
    }
    card.onclick=()=> (editing && editUnlocked) && openEditor(day);
    cal.appendChild(card);
  }
  const filled=offset+dim,rest=(7-(filled%7))%7;for(let i=0;i<rest;i++){const e=document.createElement('div');e.className='card empty';cal.appendChild(e);}
  renderTotals(days);
}
function renderTotals(days){
  const totals=document.getElementById('totals');totals.innerHTML='';
  let monthSum=0;Object.values(days).forEach(v=>monthSum+=Number(v.hours||0));
  totals.appendChild(box('Total mois',`${monthSum.toFixed(2).replace('.',',')} h`));
  const weeks={},dim=new Date(currentYear,currentMonth+1,0).getDate();
  for(let d=1;d<=dim;d++){if(days[d]){const w=weekNumber(new Date(currentYear,currentMonth,d));weeks[w]=(weeks[w]||0)+Number(days[d].hours||0);}}
  Object.keys(weeks).sort((a,b)=>a-b).forEach(w=>totals.appendChild(box(`Sem. ${w}`,`${weeks[w].toFixed(2).replace('.',',')} h`)));
  function box(t,val){const el=document.createElement('div');el.className='box';el.innerHTML=`<h3>${t}</h3><div>${val}</div>`;return el;}
}

/* √âditeur de jour */
const mb=document.getElementById('mb');
const fType=document.getElementById('fType'), fHours=document.getElementById('fHours'), fDetail=document.getElementById('fDetail'), fNote=document.getElementById('fNote');
function openEditor(day){
  editDay=day;
  const d=ensureMonth(current,currentYear,currentMonth).days[day]||{type:'C',hours:'',detail:'',note:''};
  document.getElementById('mTitle').textContent=`${String(day).padStart(2,'0')}/${String(currentMonth+1).padStart(2,'0')}/${currentYear} ‚Äî ${current}`;
  fType.value=d.type||'C';fHours.value=(d.hours??'');fDetail.value=d.detail||'';fNote.value=d.note||'';
  mb.style.display='flex';
}
function closeEditor(){mb.style.display='none';editDay=null;}
document.getElementById('btnClose').onclick=closeEditor;
document.querySelectorAll('.chip[data-preset]').forEach(ch=>{
  ch.onclick=()=>{const p=JSON.parse(ch.dataset.preset);fType.value=p.type||'C';fDetail.value=p.detail||'';if(p.autoHours&&p.detail){const h=computeHoursFromDetail(p.detail);fHours.value=(isFinite(h)?h:0);}else{fHours.value=p.hours??'';}};
});
document.getElementById('copyPrev').onclick=()=>{
  if(editDay==null)return;
  const prev=ensureMonth(current,currentYear,currentMonth).days[editDay-1];
  if(prev){fType.value=prev.type;fHours.value=prev.hours;fDetail.value=prev.detail||'';fNote.value=prev.note||'';}
};
document.getElementById('btnSave').onclick=()=>{
  if(!editUnlocked){alert("√âdition verrouill√©e.");return;}
  if(editDay==null)return;
  ensureMonth(current,currentYear,currentMonth).days[editDay]={type:fType.value,hours:Number(fHours.value||0),detail:fDetail.value.trim(),note:fNote.value.trim()};
  saveState();closeEditor();render();
};
document.getElementById('btnDel').onclick=()=>{
  if(!editUnlocked){alert("√âdition verrouill√©e.");return;}
  if(editDay==null)return;
  delete ensureMonth(current,currentYear,currentMonth).days[editDay];
  saveState();closeEditor();render();
};
document.getElementById('btnWeek').onclick=()=>{
  if(!editUnlocked){alert("√âdition verrouill√©e.");return;}
  if(editDay==null)return;
  const dt=new Date(currentYear,currentMonth,editDay),mon=mondayOf(dt),dim=new Date(currentYear,currentMonth+1,0).getDate();
  const payload={type:fType.value,hours:Number(fHours.value||0),detail:fDetail.value.trim(),note:fNote.value.trim()};
  const store=ensureMonth(current,currentYear,currentMonth).days;
  for(let i=0;i<7;i++){const d=mon.getDate()+i;if(d>=1&&d<=dim){store[d]={...payload};}}
  saveState();closeEditor();render();
};
document.getElementById('btnRange').onclick=()=>{
  if(!editUnlocked){alert("√âdition verrouill√©e.");return;}
  const ans=prompt("Appliquer du jour X au jour Y (ex: 5-12) :",""); if(!ans)return;
  const m=ans.match(/^\s*(\d{1,2})\s*[-‚Äì]\s*(\d{1,2})\s*$/); if(!m) return alert("Format invalide. Exemple : 5-12");
  let a=parseInt(m[1],10),b=parseInt(m[2],10); if(a>b)[a,b]=[b,a];
  const dim=new Date(currentYear,currentMonth+1,0).getDate();
  a=Math.max(1,Math.min(dim,a)); b=Math.max(1,Math.min(dim,b));
  const payload={type:fType.value,hours:Number(fHours.value||0),detail:fDetail.value.trim(),note:fNote.value.trim()};
  const store=ensureMonth(current,currentYear,currentMonth).days; for(let d=a;d<=b;d++){store[d]={...payload};}
  saveState();closeEditor();render();
};

/* S√©lecteur de mois */
const mpb=document.getElementById('mpb'),monthGrid=document.getElementById('monthGrid'),curYearEl=document.getElementById('curYear');
document.getElementById('monthLabel').onclick=()=>{
  curYearEl.textContent=currentYear;monthGrid.innerHTML='';
  monthNames.forEach((name,idx)=>{const b=document.createElement('button');b.textContent=name[0].toUpperCase()+name.slice(1);b.onclick=()=>{currentMonth=idx;mpb.style.display='none';saveState(true);render();};monthGrid.appendChild(b);});
  mpb.style.display='flex';
};
document.getElementById('mpClose').onclick=()=> mpb.style.display='none';
mpb.addEventListener('click',e=>{ if(e.target===mpb) mpb.style.display='none'; });

/* Gestion des noms */
const pm=document.getElementById('peopleModal'), pmList=document.getElementById('pmList');
document.getElementById('btnPeople').onclick=()=>{
  if(!editUnlocked){alert("√âdition verrouill√©e.");return;}
  pmList.innerHTML=''; people.forEach((name)=>{
    const row=document.createElement('div');row.className='pm-row';
    const inp=document.createElement('input');inp.value=name;
    const del=document.createElement('button');del.textContent='Supprimer';del.className='danger';
    del.onclick=()=>{ if(!confirm(`Supprimer "${name}" ?`))return; if(current===name){const next=people.find(n=>n!==name)||"Sabri";current=next;} delete peopleData[name]; people=people.filter(n=>n!==name); row.remove(); };
    row.appendChild(inp);row.appendChild(del);pmList.appendChild(row);
  });
  pm.style.display='flex';
};
document.getElementById('pmAdd').onclick=()=>{const row=document.createElement('div');row.className='pm-row';const inp=document.createElement('input');inp.placeholder='Nouveau nom';const del=document.createElement('button');del.textContent='Supprimer';del.className='danger';del.onclick=()=>row.remove();row.appendChild(inp);row.appendChild(del);pmList.appendChild(row);};
document.getElementById('pmCancel').onclick=()=> pm.style.display='none';
document.getElementById('pmSave').onclick=()=>{
  const inputs=pmList.querySelectorAll('input');const newList=[];inputs.forEach(inp=>{const v=inp.value.trim();if(v&&!newList.includes(v))newList.push(v);});
  if(newList.length===0){alert("Il faut au moins un nom.");return;}
  const newData={}; newList.forEach(n=>{newData[n]=peopleData[n]||{};});
  if(!newList.includes(current)) current=newList[0];
  people=newList; for(const k in peopleData) delete peopleData[k]; Object.assign(peopleData,newData);
  pm.style.display='none'; saveState(); renderSidebar(); render();
};
pm.addEventListener('click',e=>{ if(e.target===pm) pm.style.display='none'; });

/* Stats annuelles */
const statsModal=document.getElementById('statsModal');
document.getElementById('btnStats').onclick=()=>{
  const y=currentYear;document.getElementById('statsYear').textContent=y;
  const body=document.getElementById('statsBody'); body.innerHTML='';
  const table=document.createElement('table');table.style.width='100%';table.style.borderCollapse='collapse';
  const thead=document.createElement('thead');const trh=document.createElement('tr');
  ["Personne"].concat(monthNames.map(n=>n.slice(0,3))).concat(["Total"]).forEach(h=>{const th=document.createElement('th');th.textContent=h;th.style.border='1px solid #e5e7eb';th.style.padding='8px';th.style.background='#f3f4f6';trh.appendChild(th);});
  thead.appendChild(trh);table.appendChild(thead);
  const tbody=document.createElement('tbody');
  people.forEach(p=>{
    let totalYear=0; const tr=document.createElement('tr');
    const tdName=document.createElement('td');tdName.textContent=p;tdName.style.border='1px solid #e5e7eb';tdName.style.padding='8px';tr.appendChild(tdName);
    for(let m=0;m<12;m++){
      let sum=0;const store=(peopleData[p]&&peopleData[p][y]&&peopleData[p][y][m])?peopleData[p][y][m].days:{};
      Object.values(store).forEach(v=> sum+=Number(v.hours||0));
      totalYear+=sum; const td=document.createElement('td');td.textContent=sum.toFixed(1).replace('.',',');td.style.border='1px solid #e5e7eb';td.style.padding='8px';tr.appendChild(td);
    }
    const tdT=document.createElement('td');tdT.textContent=totalYear.toFixed(1).replace('.',',');tdT.style.border='1px solid #e5e7eb';tdT.style.padding='8px';tr.appendChild(tdT);
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); body.appendChild(table); statsModal.style.display='flex';
};
document.getElementById('statsClose').onclick=()=> statsModal.style.display='none';
statsModal.addEventListener('click',e=>{ if(e.target===statsModal) statsModal.style.display='none'; });

/* Top bar */
document.getElementById('btnPdf').onclick=()=>window.print();
document.getElementById('btnUnlock').onclick=()=>{
  const pwd=prompt("Mot de passe d‚Äô√©dition :");
  if(pwd===EDIT_PASSWORD){
    editUnlocked=true;document.getElementById('btnEdit').disabled=false;document.getElementById('btnPeople').disabled=false;document.getElementById('btnUnlock').textContent='D√©verrouill√© ‚úÖ';renderSidebar();
  }else{alert("Mot de passe incorrect.");}
};
document.getElementById('btnEdit').onclick=()=>{
  if(!editUnlocked){alert("√âdition verrouill√©e.");return;}
  editing=!editing; document.getElementById('btnEdit').textContent=editing?'Quitter l‚Äô√©dition':'Activer l‚Äô√©dition'; if(!editing) document.getElementById('mb').style.display='none'; render();
};
document.getElementById('btnSaveAll').onclick=()=> saveState();

document.getElementById('btnBackup').onclick=()=>{const blob=new Blob([localStorage.getItem(STORAGE_KEY)||"{}"],{type:"application/json"});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download="planning.json";a.click();URL.revokeObjectURL(a.href);};
document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').onchange=async(e)=>{const f=e.target.files[0];if(!f)return;const t=await f.text();localStorage.setItem(STORAGE_KEY,t);loadState();renderSidebar();render();showToast("Planning import√© ‚úîÔ∏è");};

document.getElementById('btnSync').onclick=async()=>{
  if(!ENABLE_SYNC||!dbFB){alert("Active la sync : remplis firebaseConfig + ENABLE_SYNC=true");return;}
  const mode=prompt("Tape 'save' pour envoyer au cloud, ou 'load' pour charger :","save");
  if(mode==="save"){await syncSave();} else if(mode==="load"){await syncLoad();}
};
function getShareKey(){let k=localStorage.getItem("planning_share_key");if(!k){k=Math.random().toString(36).slice(2,10);localStorage.setItem("planning_share_key",k);}return k;}
async function syncSave(){const key=getShareKey();const payload={people,peopleData,currentYear,currentMonth,current,ts:Date.now()};await dbFB.ref("plannings/"+key).set(payload);showToast("Synchronis√© ‚úÖ (cl√©: "+key+")");}
async function syncLoad(){const key=prompt("Cl√© de synchronisation √† charger :",getShareKey());if(!key)return;const snap=await dbFB.ref("plannings/"+key).get();if(!snap.exists()){alert("Aucune donn√©e pour cette cl√©.");return;}const s=snap.val();if(s.people)people=s.people;if(s.peopleData){for(const k in peopleData)delete peopleData[k];Object.assign(peopleData,s.peopleData);}currentYear=s.currentYear??currentYear;currentMonth=s.currentMonth??currentMonth;current=s.current??current;saveState(true);renderSidebar();render();showToast("Charg√© depuis le cloud ‚òÅÔ∏è");}

/* Menu tiroir mobile */
const sideEl=document.querySelector('.side');
const overlayEl=document.getElementById('overlay');
const menuBtn=document.getElementById('menuBtn');
function applyDrawerMode(){
  if(window.matchMedia('(max-width:880px)').matches){
    sideEl.classList.add('drawer');
  }else{
    sideEl.classList.remove('drawer','open');
    document.body.classList.remove('menu-open');
    overlayEl.style.display='none';
  }
}
function openMenu(){ if(!sideEl.classList.contains('drawer'))return; sideEl.classList.add('open'); document.body.classList.add('menu-open'); overlayEl.style.display='block'; }
function closeMenu(){ sideEl.classList.remove('open'); document.body.classList.remove('menu-open'); overlayEl.style.display='none'; }
menuBtn.addEventListener('click', openMenu);
overlayEl.addEventListener('click', closeMenu);
window.addEventListener('resize', applyDrawerMode);
applyDrawerMode();

/* Boot */
const loaded=loadState(); seedDefaultsIfEmpty(); renderSidebar();
document.getElementById('now').textContent=new Date().toLocaleString('fr-FR');
render();
</script>
</body>
</html>
